# 消息核心规范 (Messaging Core Specification)

## ADDED Requirements

### Requirement: 消息抽象层 (Message Abstraction Layer)
系统 SHALL提供一个干净的闲鱼消息处理抽象层，该层独立于底层传输机制（直接 WebSocket vs 浏览器中介）。

#### 场景：通过抽象接口发送消息
- **当** 应用调用 `send_message(chat_id, user_id, text)` 时
- **则** 消息按照闲鱼协议格式化并传输
- **并且** 实现细节（WebSocket、浏览器等）对调用者隐藏

#### 场景：通过抽象接口接收消息
- **当** 从闲鱼平台接收到消息时
- **则** 消息被解析并标准化为统一格式
- **并且** 消息被传递给注册的处理器，不暴露传输细节

### Requirement: 消息协议处理器 (Message Protocol Handler)
系统 SHALL处理闲鱼特定的消息编码、解码和协议细节。

#### 场景：编码出站消息
- **当** 向用户发送文本消息时
- **则** 系统按照闲鱼格式对内容进行 base64 编码
- **并且** 使用正确的会话元数据（cid、uuid、contentType）包装消息
- **并且** 添加必需的请求头（mid、platform、appVersion）

#### 场景：解码入站消息
- **当** 接收到加密消息数据时
- **则** 系统使用闲鱼解密算法进行解密
- **并且** 将 JSON 结构解析为消息对象
- **并且** 提取发送者信息、聊天 ID、商品 ID 和内容

### Requirement: 消息类型分类 (Message Type Classification)
系统 SHALL将入站消息分类为可操作的类型，并过滤无关消息。

#### 场景：识别用户聊天消息
- **当** 接收到的消息包含 reminderContent 字段时
- **则** 分类为用户聊天消息
- **并且** 提取用户 ID、聊天 ID、商品 ID 和消息文本

#### 场景：过滤输入状态消息
- **当** 接收到的消息表示用户正在输入时
- **则** 分类为输入状态
- **并且** 不触发消息处理器

#### 场景：过滤系统通知
- **当** 接收到的消息是系统通知（订单状态等）时
- **则** 分类为系统消息
- **并且** 适当记录日志但不触发聊天处理器

### Requirement: 消息过期处理 (Message Expiration Handling)
系统 SHALL过滤过期消息，以防止响应旧对话。

#### 场景：拒绝过期消息
- **当** 消息时间戳早于配置的阈值（默认 5 分钟）时
- **则** 消息被丢弃
- **并且** 不调用任何处理器
- **并且** 记录过期信息以便调试

#### 场景：接受最近消息
- **当** 消息时间戳在可接受范围内时
- **则** 消息继续传递给处理器
- **并且** 时间戳保留在上下文中

### Requirement: 连接状态管理 (Connection State Management)
系统 SHALL管理连接生命周期并处理重连逻辑。

#### 场景：初始化连接
- **当** 系统启动时
- **则** 建立到闲鱼消息服务的连接
- **并且** 执行身份验证握手
- **并且** 注册设备并同步状态

#### 场景：处理连接断开
- **当** 连接丢失或超时时
- **则** 使用指数退避算法尝试重连
- **并且** 保留待发送消息的队列
- **并且** 记录连接状态转换

#### 场景：优雅关闭
- **当** 系统正在关闭时
- **则** 干净地关闭连接
- **并且** 刷新待发送消息
- **并且** 保存状态以供下次启动

### Requirement: 消息处理器注册 (Message Handler Registration)
系统 SHALL允许注册自定义处理器来处理不同的消息类型，而无需修改核心消息逻辑。

#### 场景：注册聊天消息处理器
- **当** 应用为用户聊天消息注册处理器时
- **则** 对每条入站用户消息调用该处理器
- **并且** 处理器接收标准化的消息数据（chat_id、user_id、content、item_id）

#### 场景：注册系统事件处理器
- **当** 应用为订单事件注册处理器时
- **则** 对订单状态变更调用该处理器
- **并且** 处理器接收事件类型和元数据

### Requirement: 传输独立性 (Transport Independence)
系统 SHALL通过通用接口支持多种传输实现（直接 WebSocket、浏览器 CDP）。

#### 场景：在传输模式之间切换
- **当** 配置更改传输模式时
- **则** 系统使用适当的传输实现
- **并且** 应用代码保持不变
- **并且** 跨传输保留消息语义

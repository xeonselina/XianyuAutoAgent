openapi: 3.0.3
info:
  title: AI 客服 Agent API
  description: |
    基于 Gemini 的 AI 客服 Agent 系统 HTTP API (内网部署)
    
    **核心功能**:
    - 流式/同步对话接口
    - 会话管理
    - 知识库管理
    
    **参考架构**: gemini-cli Plan-Action-Check 模式
  version: 1.0.0

servers:
  - url: http://localhost:8000
    description: 本地开发环境
  - url: http://192.168.1.100:8000
    description: 内网部署环境

tags:
  - name: chat
    description: 对话接口
  - name: session
    description: 会话管理
  - name: human-agent
    description: 人工客服接口 (Human-in-the-Loop)
  - name: knowledge
    description: 知识库管理
  - name: system
    description: 系统接口

paths:
  /chat/stream:
    post:
      tags: [chat]
      summary: 流式对话接口 (推荐)
      description: |
        使用 Server-Sent Events (SSE) 实时流式返回 Agent 响应。
        
        **推荐场景**: Web/移动端实时对话界面
      operationId: chatStream
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              simple_question:
                summary: 简单提问
                value:
                  session_id: "550e8400-e29b-41d4-a716-446655440000"
                  query: "如何申请退款?"
              new_session:
                summary: 新会话 (自动创建 session)
                value:
                  query: "我想咨询售后问题"
      responses:
        '200':
          description: SSE 流式响应
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  SSE 事件流,格式为:
                  ```
                  data: {"type": "text", "content": "您好..."}\n\n
                  data: {"type": "tool_call", "name": "knowledge_search"}\n\n
                  data: {"type": "text", "content": "根据查询结果..."}\n\n
                  data: {"type": "done", "session_id": "..."}\n\n
                  ```
              examples:
                stream_response:
                  summary: 流式响应示例
                  value: |
                    data: {"type": "text", "content": "您好,我来帮您查询退款政策"}\n\n
                    data: {"type": "tool_call", "name": "knowledge_search", "args": {"query": "退款政策"}}\n\n
                    data: {"type": "text", "content": "根据我们的政策,您可以在收货后7天内申请退款..."}\n\n
                    data: {"type": "done", "session_id": "550e8400-e29b-41d4-a716-446655440000"}\n\n
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /chat:
    post:
      tags: [chat]
      summary: 同步对话接口
      description: |
        等待完整响应后一次性返回,适用于批处理场景。
        
        **推荐场景**: API 集成、批处理
      operationId: chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: 对话响应
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                success_response:
                  summary: 成功响应
                  value:
                    session_id: "550e8400-e29b-41d4-a716-446655440000"
                    message:
                      role: "assistant"
                      content: "根据退款政策,您可以在收货后7天内申请退款..."
                      timestamp: "2025-12-22T10:30:05Z"
                    status: "completed"
                    turn_counter: 3
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /sessions/{session_id}:
    get:
      tags: [session]
      summary: 查询会话详情
      description: 获取指定会话的完整历史和状态
      operationId: getSession
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: 会话 ID
      responses:
        '200':
          description: 会话详情
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Session'
        '404':
          description: 会话不存在或已过期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    delete:
      tags: [session]
      summary: 删除会话
      description: 手动删除会话 (清理 Redis 缓存)
      operationId: deleteSession
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: 删除成功
        '404':
          description: 会话不存在

  /sessions/{session_id}/human-takeover:
    post:
      tags: [session]
      summary: 人工接管会话
      description: |
        当 Agent 调用 transfer_to_human 后,人工客服通过此接口接管会话。
        
        **使用场景**: 
        - Agent 自信度低于阈值
        - 知识库无法回答的问题
        - 需要人工判断的复杂场景
      operationId: humanTakeover
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [agent_id]
              properties:
                agent_id:
                  type: string
                  description: 接管的人工客服 ID
                  example: "agent_001"
                notes:
                  type: string
                  description: 接管备注
                  example: "用户咨询复杂退款问题"
      responses:
        '200':
          description: 接管成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  session_id:
                    type: string
                  status:
                    type: string
                    example: "human_handling"
                  agent_id:
                    type: string
                  context:
                    type: object
                    description: Agent 提供的上下文信息
        '404':
          description: 会话不存在
        '409':
          description: 会话状态冲突 (例如已被其他人工接管)

  /human-agent/pending-requests:
    get:
      tags: [human-agent]
      summary: 查询待处理的人工协助请求
      description: |
        Human-in-the-Loop 模式: 查询所有等待人工回复的请求。
        
        Agent 调用 ask_human_agent 工具后会创建请求，人工客服通过此接口获取待处理列表。
      operationId: getPendingRequests
      parameters:
        - name: urgency
          in: query
          schema:
            type: string
            enum: [low, medium, high]
          description: 按紧急程度过滤
        - name: question_type
          in: query
          schema:
            type: string
            enum: [information_query, decision_required, risk_confirmation, knowledge_gap]
          description: 按问题类型过滤
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: 待处理请求列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/HumanRequestSummary'
                  total:
                    type: integer
                  page:
                    type: integer
                  page_size:
                    type: integer
              examples:
                pending_requests:
                  summary: 待处理请求示例
                  value:
                    items:
                      - request_id: "req_001"
                        session_id: "550e8400-e29b-41d4-a716-446655440000"
                        question: "请帮我查询订单 #12345 的发货时间"
                        question_type: "information_query"
                        urgency: "medium"
                        created_at: "2025-12-22T10:35:00Z"
                        waiting_seconds: 45
                    total: 3
                    page: 1
                    page_size: 20

  /sessions/{session_id}/pending-request:
    get:
      tags: [human-agent]
      summary: 查看会话的待处理请求详情
      description: |
        获取指定会话的当前待处理人工协助请求及完整对话历史。
        
        用于人工客服了解上下文，准备回复。
      operationId: getPendingRequestDetail
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 请求详情
          content:
            application/json:
              schema:
                type: object
                properties:
                  request:
                    $ref: '#/components/schemas/HumanRequest'
                  conversation_history:
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
              examples:
                request_detail:
                  summary: 请求详情示例
                  value:
                    request:
                      request_id: "req_001"
                      question: "请帮我查询订单 #12345 的发货时间"
                      question_type: "information_query"
                      context:
                        user_question: "我的订单什么时候发货?"
                        order_id: "#12345"
                      urgency: "medium"
                      status: "pending"
                    conversation_history:
                      - role: "user"
                        content: "我的订单什么时候发货?"
                        timestamp: "2025-12-22T10:34:00Z"
                      - role: "assistant"
                        content: "正在为您核实订单信息，请稍候..."
                        timestamp: "2025-12-22T10:35:00Z"
        '404':
          description: 会话不存在或无待处理请求

  /sessions/{session_id}/human-response:
    post:
      tags: [human-agent]
      summary: 人工回复协助请求
      description: |
        Human-in-the-Loop 模式: 人工客服回复 Agent 的协助请求。
        
        回复后，Agent 会继续执行并基于此信息回答用户。
      operationId: submitHumanResponse
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [request_id, human_agent_id]
              properties:
                request_id:
                  type: string
                  description: 请求 ID
                  example: "req_001"
                human_agent_id:
                  type: string
                  description: 人工客服 ID
                  example: "agent_001"
                response:
                  type: string
                  description: 文本回复 (用于 information_query 或 knowledge_gap)
                  example: "订单已于 2025-12-20 发货，物流单号 SF123456"
                selected_option:
                  type: string
                  description: 选择的选项 ID (用于 decision_required 或 risk_confirmation)
                  example: "B"
                notes:
                  type: string
                  description: 备注 (可选)
            examples:
              text_response:
                summary: 文本回复
                value:
                  request_id: "req_001"
                  human_agent_id: "agent_001"
                  response: "订单已于 2025-12-20 发货，物流单号 SF123456"
              option_selection:
                summary: 选项选择
                value:
                  request_id: "req_002"
                  human_agent_id: "agent_001"
                  selected_option: "B"
                  notes: "批准 50% 退款，符合拆封商品政策"
      responses:
        '200':
          description: 回复成功，Agent 已继续执行
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  request_id:
                    type: string
                  session_id:
                    type: string
                  status:
                    type: string
                    enum: [answered]
                  message:
                    type: string
              example:
                success: true
                request_id: "req_001"
                session_id: "550e8400-e29b-41d4-a716-446655440000"
                status: "answered"
                message: "Agent 已继续执行"
        '404':
          description: 会话或请求不存在
        '409':
          description: 请求已被回复或超时

  /knowledge/search:
    post:
      tags: [knowledge]
      summary: 搜索知识库
      description: 直接查询知识库,用于测试和调试
      operationId: searchKnowledge
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [query]
              properties:
                query:
                  type: string
                  description: 搜索查询
                  example: "退款政策"
                top_k:
                  type: integer
                  description: 返回结果数量
                  default: 5
                  minimum: 1
                  maximum: 20
                category:
                  type: string
                  description: 过滤分类
                  example: "售后服务"
      responses:
        '200':
          description: 搜索结果
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/KnowledgeEntry'
                  count:
                    type: integer
                    description: 结果数量

  /knowledge:
    post:
      tags: [knowledge]
      summary: 添加知识条目
      description: 向知识库添加新文档
      operationId: addKnowledge
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/KnowledgeEntryCreate'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KnowledgeEntry'
        '400':
          $ref: '#/components/responses/BadRequest'

    get:
      tags: [knowledge]
      summary: 列出知识条目
      description: 分页获取知识库列表
      operationId: listKnowledge
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
            minimum: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: category
          in: query
          schema:
            type: string
          description: 按分类过滤
      responses:
        '200':
          description: 知识列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/KnowledgeEntry'
                  total:
                    type: integer
                  page:
                    type: integer
                  page_size:
                    type: integer

  /knowledge/{id}:
    put:
      tags: [knowledge]
      summary: 更新知识条目
      operationId: updateKnowledge
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/KnowledgeEntryCreate'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KnowledgeEntry'
        '404':
          description: 知识条目不存在
    
    delete:
      tags: [knowledge]
      summary: 删除知识条目
      operationId: deleteKnowledge
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 删除成功
        '404':
          description: 知识条目不存在

  /health:
    get:
      tags: [system]
      summary: 健康检查
      description: 检查服务和依赖状态
      operationId: healthCheck
      responses:
        '200':
          description: 服务正常
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, degraded, unhealthy]
                  checks:
                    type: object
                    properties:
                      redis:
                        type: string
                        enum: [ok, error]
                      chroma:
                        type: string
                        enum: [ok, error]
                      gemini_api:
                        type: string
                        enum: [ok, error]
              example:
                status: "healthy"
                checks:
                  redis: "ok"
                  chroma: "ok"
                  gemini_api: "ok"

components:
  schemas:
    ChatRequest:
      type: object
      required: [query]
      properties:
        session_id:
          type: string
          format: uuid
          description: |
            会话 ID (可选)
            - 如果提供: 继续现有会话
            - 如果不提供: 自动创建新会话
          example: "550e8400-e29b-41d4-a716-446655440000"
        query:
          type: string
          description: 用户输入
          minLength: 1
          maxLength: 10000
          example: "如何申请退款?"
        user_id:
          type: string
          description: 用户 ID (可选,用于关联用户)
          example: "user_12345"
        context:
          type: object
          description: 额外上下文信息 (可选)
          additionalProperties: true
          example:
            order_id: "ORD-20251222-001"
            channel: "web"

    ChatResponse:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
          description: 会话 ID
        message:
          $ref: '#/components/schemas/Message'
        status:
          type: string
          enum: [active, completed, aborted, error]
          description: 会话状态
        turn_counter:
          type: integer
          description: 当前轮次

    Session:
      type: object
      properties:
        session_id:
          type: string
          format: uuid
        user_id:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        messages:
          type: array
          items:
            $ref: '#/components/schemas/Message'
        turn_counter:
          type: integer
        status:
          type: string
          enum: [active, completed, aborted, waiting_for_human, error]
        context:
          type: object
          additionalProperties: true
        terminate_reason:
          type: string
          nullable: true
          enum: [goal, timeout, error, max_turns]
        pending_human_request:
          $ref: '#/components/schemas/HumanRequest'
          nullable: true
        human_request_history:
          type: array
          items:
            $ref: '#/components/schemas/HumanRequest'
        metadata:
          type: object
          additionalProperties: true

    Message:
      type: object
      required: [role, content, timestamp]
      properties:
        role:
          type: string
          enum: [user, assistant, tool]
        content:
          type: string
        timestamp:
          type: string
          format: date-time
        tool_calls:
          type: array
          items:
            $ref: '#/components/schemas/ToolCall'
          nullable: true
        tool_call_id:
          type: string
          nullable: true
        tool_name:
          type: string
          nullable: true
        metadata:
          type: object
          additionalProperties: true

    ToolCall:
      type: object
      required: [id, name, args]
      properties:
        id:
          type: string
        name:
          type: string
        args:
          type: object
          additionalProperties: true
        status:
          type: string
          enum: [pending, executing, success, error]
        result:
          nullable: true
        error:
          type: string
          nullable: true
        duration_ms:
          type: integer
          nullable: true

    KnowledgeEntry:
      type: object
      required: [id, title, content]
      properties:
        id:
          type: string
        title:
          type: string
        content:
          type: string
        category:
          type: string
          nullable: true
        tags:
          type: array
          items:
            type: string
        source:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        priority:
          type: integer
          minimum: 0
          maximum: 100
        active:
          type: boolean

    KnowledgeEntryCreate:
      type: object
      required: [title, content]
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
        content:
          type: string
          minLength: 10
        category:
          type: string
        tags:
          type: array
          items:
            type: string
          maxItems: 10
        source:
          type: string
        priority:
          type: integer
          default: 0
          minimum: 0
          maximum: 100
        active:
          type: boolean
          default: true

    Error:
      type: object
      properties:
        error:
          type: string
          description: 错误类型
        message:
          type: string
          description: 错误详情
        details:
          type: object
          additionalProperties: true

    HumanRequestOption:
      type: object
      required: [id, label]
      properties:
        id:
          type: string
          description: 选项 ID
        label:
          type: string
          description: 选项标签
        description:
          type: string
          description: 选项说明

    HumanRequest:
      type: object
      required: [request_id, question, question_type]
      properties:
        request_id:
          type: string
          description: 请求唯一 ID
        question:
          type: string
          description: 向人工提出的具体问题
        question_type:
          type: string
          enum: [information_query, decision_required, risk_confirmation, knowledge_gap]
          description: 问题类型
        context:
          type: object
          additionalProperties: true
          description: 提供给人工的上下文信息
        options:
          type: array
          items:
            $ref: '#/components/schemas/HumanRequestOption'
          nullable: true
          description: 决策选项 (可选)
        urgency:
          type: string
          enum: [low, medium, high]
          default: medium
          description: 紧急程度
        status:
          type: string
          enum: [pending, answered, timeout]
          description: 请求状态
        created_at:
          type: string
          format: date-time
        answered_at:
          type: string
          format: date-time
          nullable: true
        human_agent_id:
          type: string
          nullable: true
          description: 处理该请求的人工客服 ID
        response:
          type: string
          nullable: true
          description: 人工的文本回复
        selected_option:
          type: string
          nullable: true
          description: 人工选择的选项 ID
        metadata:
          type: object
          additionalProperties: true

    HumanRequestSummary:
      type: object
      description: 人工协助请求摘要 (用于列表展示)
      properties:
        request_id:
          type: string
        session_id:
          type: string
          format: uuid
        question:
          type: string
        question_type:
          type: string
          enum: [information_query, decision_required, risk_confirmation, knowledge_gap]
        urgency:
          type: string
          enum: [low, medium, high]
        created_at:
          type: string
          format: date-time
        waiting_seconds:
          type: integer
          description: 等待时长 (秒)

  responses:
    BadRequest:
      description: 请求参数错误
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "ValidationError"
            message: "query 字段不能为空"
    
    InternalError:
      description: 服务器内部错误
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "InternalServerError"
            message: "处理请求时发生错误"

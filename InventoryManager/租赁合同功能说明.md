# 租赁合同功能说明

## 功能概述

新增了租赁合同功能，用户可以通过甘特图界面直接生成标准的设备租赁合同，支持身份证OCR识别，自动填入承租方信息。

## 功能特性

### 1. 租赁合同按钮
- **位置**: 租赁时段弹出层右上角
- **样式**: 绿色按钮，带有文档图标
- **功能**: 点击后在新窗口中打开租赁合同页面

### 2. 身份证上传识别
- **支持格式**: JPG、PNG、JPEG
- **上传方式**: 点击上传或拖拽上传
- **OCR识别**: 自动识别姓名和身份证号码
- **识别技术**: PaddleOCR（本地识别）+ 测试数据兜底

### 3. 合同模板
- **模板基础**: 基于Word文档设计
- **自动填充**: 设备信息、租赁信息、费用信息
- **标准格式**: 包含甲乙双方信息、条款、签字区域
- **动态计算**: 自动计算租赁天数、总费用、押金

### 4. 打印功能
- **打印优化**: 隐藏上传区域和按钮，仅显示合同内容
- **格式适配**: 适合A4纸张打印
- **样式调整**: 打印时优化字体和间距

## 安装依赖

```bash
# 安装图像处理和OCR依赖
pip install Pillow==10.0.0
pip install paddlepaddle==2.5.1
pip install paddleocr==2.7.0.3

# 或使用requirements.txt安装
pip install -r requirements.txt
```

## 使用方法

### 步骤1: 打开租赁合同
1. 在甘特图页面，找到需要生成合同的租赁时段
2. 将鼠标悬停在租赁时段上，等待弹出信息框
3. 在信息框右上角点击绿色的"租赁合同"按钮
4. 系统将在新窗口中打开租赁合同页面

### 步骤2: 上传身份证
1. 在合同页面顶部的上传区域中点击"选择照片"
2. 选择清晰的身份证正面照片
3. 也可以直接将照片拖拽到上传区域
4. 系统会自动进行OCR识别

### 步骤3: 确认识别结果
1. 识别完成后，会在上传区域显示识别结果
2. 检查识别的姓名和身份证号码是否正确
3. 如果正确，点击"填入合同"按钮

### 步骤4: 生成合同
1. 身份证信息会自动填入合同的承租方信息
2. 合同中的设备信息、租赁信息会自动从数据库填充
3. 费用信息会根据设备日租金自动计算

### 步骤5: 打印合同
1. 检查合同信息是否完整正确
2. 点击页面右下角的"打印合同"按钮
3. 在打印预览中确认格式无误后进行打印

## 技术实现

### 前端技术
- **HTML模板**: Jinja2模板引擎
- **样式框架**: Bootstrap 5
- **图标**: Bootstrap Icons
- **JavaScript**: 原生JavaScript实现文件上传和OCR交互

### 后端技术
- **Web框架**: Flask
- **路由处理**: `/rental-contract/<rental_id>`
- **OCR API**: `/api/ocr/id-card`
- **图像处理**: Pillow
- **OCR识别**: PaddleOCR

### 数据库
- **租赁信息**: 从Rental表获取
- **设备信息**: 从Device表获取
- **关联查询**: 自动关联租赁记录和设备信息

## 配置说明

### OCR配置
```python
# 在web.py中的OCR配置
ocr = PaddleOCR(
    use_angle_cls=True,  # 启用角度分类
    lang='ch',           # 中文识别
    use_gpu=False        # 使用CPU（更兼容）
)
```

### 合同模板配置
```python
# 可在_prepare_contract_data函数中调整
daily_rate = 100      # 默认日租金
deposit_ratio = 2     # 押金倍数
```

## 故障排除

### 1. OCR识别失败
- **检查**: 确保照片清晰，身份证信息完整
- **重试**: 可以重新上传其他角度的照片
- **兜底**: 系统会显示测试数据，可手动修改

### 2. 页面无法打开
- **检查**: 确保租赁记录ID有效
- **重试**: 刷新甘特图页面，重新点击按钮

### 3. 打印格式问题
- **设置**: 在浏览器打印设置中选择A4纸张
- **边距**: 建议设置较小的页边距
- **缩放**: 如果内容过大，可适当调整缩放比例

## 文件结构

```
InventoryManager/
├── app/routes/web.py              # 后端路由和API
├── templates/rental_contract.html # 合同页面模板
├── static/js/gantt.js            # 甘特图JS（添加了合同按钮）
├── requirements.txt              # 依赖包配置
└── test_contract_feature.py      # 功能测试脚本
```

## 示例合同内容

合同包含以下主要部分：
1. **合同标题和编号**
2. **甲乙双方信息** - 承租方信息通过OCR自动填入
3. **设备信息表格** - 设备名称、型号、序列号、租赁期限
4. **费用条款** - 日租金、总费用、押金
5. **交付条款** - 发货时间、收货地址、归还时间
6. **权利义务** - 甲乙双方的权利和义务
7. **违约责任** - 逾期、损坏、丢失的责任条款
8. **签字区域** - 甲乙双方签名和日期

## 安全考虑

1. **文件上传**: 限制文件类型和大小
2. **图像验证**: 验证上传文件是否为有效图像
3. **OCR数据**: 识别结果需要用户确认后才填入合同
4. **隐私保护**: 上传的身份证图像不会保存到服务器

## 扩展功能

未来可以考虑增加的功能：
1. **电子签名**: 支持电子签名功能
2. **合同存档**: 将生成的合同保存为PDF
3. **多模板**: 支持不同类型的合同模板
4. **批量生成**: 支持批量生成多个合同
5. **云端OCR**: 集成百度、腾讯等云端OCR服务

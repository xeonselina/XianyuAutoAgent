# 库存管理系统（InventoryManager）项目规格文档

## 项目概述

### 项目基本信息
- **项目名称**: 库存管理服务 (Inventory Management Service)
- **项目类型**: 基于Web的内网库存管理系统
- **技术架构**: 前后端分离，容器化部署
- **主要功能**: 甘特图界面、库存查询、租赁管理、OCR识别、合同管理

### 业务背景
这是一个专为手机租赁业务设计的库存管理系统，主要用于管理设备的租赁档期、物流追踪、合同生成等核心业务功能。系统支持手机设备及其附件的统一管理，通过甘特图可视化展示设备租赁时间线。

## 技术架构

### 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (Vue3)    │    │   后端 (Flask)   │    │   数据库 (MySQL) │
│                 │    │                 │    │                 │
│ - Element Plus  │◄──►│ - RESTful API   │◄──►│ - 主要业务数据   │
│ - TypeScript    │    │ - SQLAlchemy    │    │ - 审计日志      │
│ - Pinia         │    │ - Flask-Migrate │    │                 │
│ - Vite          │    │ - Gunicorn      │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │              ┌─────────────────┐              │
         │              │  辅助服务组件    │              │
         └──────────────┤                 ├──────────────┘
                        │ 
                        │ - Nginx (代理)  │
                        │ - 定时任务调度   │
                        │ - OCR识别服务   │
                        │ - 顺丰快递API   │
                        └─────────────────┘
```

### 技术栈详细说明

#### 后端技术栈
- **核心框架**: Flask 2.3.3
- **数据库ORM**: SQLAlchemy 3.0.5
- **数据库迁移**: Flask-Migrate 4.0.5
- **跨域支持**: Flask-CORS 4.0.0
- **数据库驱动**: PyMySQL 1.1.0
- **生产服务器**: Gunicorn 21.2.0 + Gevent 23.7.0
- **环境配置**: python-dotenv 1.0.0
- **图像处理**: Pillow 10.0.0
- **OCR服务**: 阿里云OCR API
- **定时任务**: schedule 1.2.0
- **HTTP请求**: requests 2.31.0
- **文档处理**: python-docx 1.2.0 + beautifulsoup4 4.13.4

#### 前端技术栈
- **核心框架**: Vue 3.5.18
- **UI组件库**: Element Plus 2.11.1
- **状态管理**: Pinia 3.0.3
- **路由管理**: Vue Router 4.5.1
- **构建工具**: Vite 7.0.6
- **开发语言**: TypeScript 5.8.0
- **HTTP客户端**: Axios 1.11.0
- **日期处理**: Day.js 1.11.14
- **日期选择器**: @vuepic/vue-datepicker 11.0.2

#### 数据库与存储
- **主数据库**: MySQL 8.0
- **字符集**: UTF8MB4

#### 部署与运维
- **容器化**: Docker + Docker Compose
- **多架构支持**: ARM64 + AMD64
- **健康检查**: 内置健康检查机制
- **日志管理**: RotatingFileHandler
- **环境隔离**: 开发/测试/生产环境配置分离

### 代码架构设计

#### 分层架构模式
本项目采用标准的三层架构模式，确保代码的可维护性和可扩展性：

```
┌─────────────────────────────────────────────────────────────┐
│                     路由层 (Routes)                         │
│  /app/routes/                                               │
│  ├── rental_api.py       - 租赁API路由定义                  │
│  ├── device_api.py       - 设备API路由定义                  │
│  ├── gantt_api.py        - 甘特图API路由定义                │
│  └── web.py             - Web界面路由集成                  │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                   处理器层 (Handlers)                       │
│  /app/handlers/                                             │
│  ├── rental_handlers.py  - 租赁请求处理逻辑                │
│  ├── device_handlers.py  - 设备请求处理逻辑                │
│  └── [其他功能handlers]                                     │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    服务层 (Services)                        │
│  /app/services/                                             │
│  ├── rental/                                               │
│  │   └── rental_service.py  - 租赁业务逻辑                 │
│  ├── inventory_service.py    - 库存管理服务                │
│  ├── device_service.py       - 设备管理服务                │
│  └── scheduler/              - 定时任务服务                │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据层 (Models)                          │
│  /app/models/                                               │
│  ├── rental.py           - 租赁记录模型                     │
│  ├── device.py           - 设备模型                        │
│  ├── device_model.py     - 设备型号模型                    │
│  └── audit_log.py        - 审计日志模型                    │
└─────────────────────────────────────────────────────────────┘
```

#### 架构优势

1. **关注点分离**: 每层专注于特定的职责
   - 路由层：处理HTTP请求路由和参数绑定
   - 处理器层：处理请求验证、数据转换和响应格式化
   - 服务层：实现核心业务逻辑和事务管理
   - 数据层：数据持久化和数据库操作

2. **模块化设计**: 按功能领域拆分模块
   - 租赁模块：从1030行精简到93行（减少91%）
   - 每个模块独立可测试和维护
   - 降低模块间的耦合度

3. **可扩展性**:
   - 新功能可独立开发和部署
   - 支持微服务架构演进
   - 便于团队协作开发

4. **一致性**: 统一的错误处理、日志记录和响应格式

## 数据模型设计

### 核心数据表结构

#### 1. 设备表 (devices)
```sql
CREATE TABLE devices (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '设备ID',
    name VARCHAR(100) NOT NULL COMMENT '设备名称',
    serial_number VARCHAR(100) UNIQUE COMMENT '设备序列号',
    model VARCHAR(50) NOT NULL DEFAULT 'x200u' COMMENT '设备型号',
    model_id INT COMMENT '设备型号ID',
    is_accessory BOOLEAN DEFAULT FALSE COMMENT '是否为附件',
    status ENUM('online', 'offline') DEFAULT 'online' COMMENT '设备状态',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (model_id) REFERENCES device_models(id)
);
```

**字段说明**:
- `id`: 设备主键ID，自增
- `name`: 设备显示名称
- `serial_number`: 设备序列号，用于唯一标识
- `model`: 设备型号简称
- `model_id`: 关联设备型号表的外键
- `is_accessory`: 标识是否为附件设备（如充电器、耳机等）
- `status`: 设备状态，online（在线可用）/ offline（离线不可用）

#### 2. 设备型号表 (device_models)
```sql
CREATE TABLE device_models (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '型号ID',
    name VARCHAR(50) NOT NULL UNIQUE COMMENT '型号名称',
    display_name VARCHAR(100) NOT NULL COMMENT '显示名称',
    description TEXT COMMENT '型号描述',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    default_accessories TEXT COMMENT '默认附件列表，JSON格式',
    device_value DECIMAL(10,2) COMMENT '设备价值',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
);
```

#### 3. 型号附件关系表 (model_accessories)
```sql
CREATE TABLE model_accessories (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '关系ID',
    model_id INT NOT NULL COMMENT '主设备型号ID',
    accessory_name VARCHAR(100) NOT NULL COMMENT '附件名称',
    accessory_description TEXT COMMENT '附件描述',
    accessory_value DECIMAL(10,2) COMMENT '附件价值',
    is_required BOOLEAN DEFAULT FALSE COMMENT '是否必需附件',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (model_id) REFERENCES device_models(id)
);
```

#### 4. 租赁记录表 (rentals)
```sql
CREATE TABLE rentals (
    id INT AUTO_INCREMENT PRIMARY KEY,
    device_id INT NOT NULL COMMENT '设备ID',
    start_date DATE NOT NULL COMMENT '开始日期',
    end_date DATE NOT NULL COMMENT '结束日期',
    ship_out_time DATETIME COMMENT '寄出时间',
    ship_in_time DATETIME COMMENT '收回时间',
    customer_name VARCHAR(100) NOT NULL COMMENT '客户姓名',
    customer_phone VARCHAR(20) COMMENT '客户电话',
    destination VARCHAR(100) COMMENT '目的地',
    ship_out_tracking_no VARCHAR(50) COMMENT '寄出快递单号',
    ship_in_tracking_no VARCHAR(50) COMMENT '寄回快递单号',
    status ENUM('not_shipped', 'shipped', 'returned', 'completed', 'cancelled') DEFAULT 'not_shipped' COMMENT '租赁状态',
    parent_rental_id INT COMMENT '父租赁记录ID（用于关联主设备和附件）',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    FOREIGN KEY (device_id) REFERENCES devices(id),
    FOREIGN KEY (parent_rental_id) REFERENCES rentals(id)
);
```

**租赁状态说明**:
- `not_shipped`: 未发货
- `shipped`: 已发货
- `returned`: 已收回
- `completed`: 已完成
- `cancelled`: 已取消

**附件关联机制**:
- 主设备租赁: `parent_rental_id` 为 NULL
- 附件租赁: `parent_rental_id` 指向主设备租赁记录的ID
- 通过这种设计实现主设备和附件的关联管理

#### 5. 审计日志表 (audit_logs)
```sql
CREATE TABLE audit_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    device_id INT COMMENT '相关设备ID',
    rental_id INT COMMENT '相关租赁ID',
    action VARCHAR(50) NOT NULL COMMENT '操作类型',
    resource_type VARCHAR(50) COMMENT '资源类型',
    resource_id VARCHAR(50) COMMENT '资源ID',
    description TEXT COMMENT '操作描述',
    details JSON COMMENT '操作详情',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    user_agent VARCHAR(500) COMMENT '用户代理',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (device_id) REFERENCES devices(id),
    FOREIGN KEY (rental_id) REFERENCES rentals(id)
);
```

#### 6. 租赁附件表 (rental_accessories) - 已废弃
```sql
-- 注意：此表已废弃，新架构中附件租赁直接作为独立的Rental记录处理
-- 通过 Rental.parent_rental_id 关联到主租赁记录
```

### 数据模型关系图
```
device_models (1) ──────── (N) devices
     │                         │
     │                         │
     │                         └─── (1) ──────── (N) rentals
     │                                                │
     └─── (1) ──────── (N) model_accessories           │
                                                       │
audit_logs (N) ──────── (1) devices                   │
audit_logs (N) ──────── (1) rentals ──────────────────┘
                              │
                              └─── parent_rental_id (自关联)
```

## API接口设计

### API架构设计

系统采用RESTful API设计风格，基于分层架构模式实现，确保代码的可维护性和扩展性。API处理流程如下：

**请求处理流程**:
```
HTTP请求 → 路由层 → 处理器层 → 服务层 → 数据层 → 数据库
```

**架构特点**:
- **路由层**: 负责URL路由匹配和HTTP方法绑定
- **处理器层**: 负责请求验证、数据格式化和响应构建
- **服务层**: 负责业务逻辑实现和事务管理
- **统一错误处理**: 所有异常都会被捕获并返回标准格式错误

所有API返回JSON格式数据，统一的响应格式：

```json
{
  "success": true|false,
  "data": {}, // 成功时的数据
  "error": "错误信息", // 失败时的错误信息
  "message": "操作提示", // 操作结果提示
  "meta": {} // 元数据（如分页信息）
}
```

### 核心API接口列表

#### 1. 库存查询API

##### 查询可用设备
```http
GET /api/inventory/available
```

**请求参数**:
- `start_date` (required): 开始日期 (YYYY-MM-DD)
- `end_date` (required): 结束日期 (YYYY-MM-DD)
- `device_type` (optional): 设备类型过滤

**响应示例**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "iPhone 15 Pro",
      "serial_number": "ABC123456",
      "status": "online",
      "location": null
    }
  ],
  "total_available": 5,
  "query_params": {
    "start_date": "2024-01-15",
    "end_date": "2024-01-17",
    "device_type": null
  }
}
```

#### 2. 租赁管理API

##### 获取租赁记录列表
```http
GET /api/rentals
```

##### 创建租赁记录
```http
POST /api/rentals
```

**请求体**:
```json
{
  "device_id": 1,
  "start_date": "2024-01-15",
  "end_date": "2024-01-17",
  "customer_name": "张三",
  "customer_phone": "13800138000",
  "destination": "北京市朝阳区",
  "ship_out_time": "2024-01-15 19:00:00",
  "ship_in_time": "2024-01-18 12:00:00",
  "accessories": [2, 3], // 附件设备ID数组
  "force_create": false // 是否强制创建（忽略冲突）
}
```

##### 更新租赁记录
```http
PUT /api/rentals/{rental_id}
```

##### 删除租赁记录
```http
DELETE /api/rentals/{rental_id}
```

##### 更新租赁状态
```http
PUT /api/rentals/{rental_id}/status
```

**请求体**:
```json
{
  "status": "shipped" // not_shipped, shipped, returned, completed, cancelled
}
```

##### 检查租赁冲突
```http
POST /api/rentals/check-conflict
```

**请求体**:
```json
{
  "device_id": 1,
  "start_date": "2024-01-15",
  "end_date": "2024-01-17",
  "exclude_rental_id": 5 // 可选，编辑时排除的租赁ID
}
```

##### 检查重复租赁
```http
POST /api/rentals/check-duplicate
```

#### 3. 设备管理API

##### 获取设备列表
```http
GET /api/devices
```

##### 创建设备
```http
POST /api/devices
```

##### 更新设备
```http
PUT /api/devices/{device_id}
```

##### 删除设备
```http
DELETE /api/devices/{device_id}
```

#### 4. 设备型号管理API

##### 获取设备型号列表
```http
GET /api/device-models
```

##### 创建设备型号
```http
POST /api/device-models
```

##### 更新设备型号
```http
PUT /api/device-models/{model_id}
```

#### 5. 甘特图API

##### 获取甘特图数据
```http
GET /api/gantt/data
```

**请求参数**:
- `start_date` (optional): 开始日期
- `end_date` (optional): 结束日期
- `include_accessories` (optional): 是否包含附件

**响应示例**:
```json
{
  "success": true,
  "data": {
    "devices": [
      {
        "id": 1,
        "name": "iPhone 15 Pro",
        "rentals": [
          {
            "id": 1,
            "start_date": "2024-01-15",
            "end_date": "2024-01-17",
            "customer_name": "张三",
            "status": "shipped"
          }
        ]
      }
    ],
    "date_range": {
      "start": "2024-01-01",
      "end": "2024-01-31"
    }
  }
}
```

#### 6. OCR识别API

##### 身份证OCR识别
```http
POST /api/ocr/id-card
```

**请求**: multipart/form-data
- `image`: 身份证图片文件

**响应**:
```json
{
  "success": true,
  "data": {
    "name": "张三",
    "id_number": "110101199001011234",
    "address": "北京市朝阳区",
    "confidence": 0.95
  }
}
```

#### 7. 物流追踪API

##### 查询快递状态
```http
GET /api/tracking/{tracking_number}
```

##### 获取租赁物流信息
```http
GET /api/tracking/rental/{rental_id}
```

#### 8. 合同生成API

##### 生成租赁合同
```http
GET /contract/{rental_id}
```

##### 生成发货单
```http
GET /shipping/{rental_id}
```

### API认证与安全
- 目前系统为内网使用，未实现用户认证
- 所有API接口支持CORS跨域访问
- 使用HTTPS加密传输（生产环境）
- 请求日志记录和审计

## 前端组件架构

### 组件层次结构
```
App.vue (根组件)
├── RouterView (路由视图)
│   ├── GanttView.vue (甘特图主视图)
│   │   ├── GanttChart.vue (甘特图核心组件)
│   │   ├── GanttRow.vue (甘特图行组件)
│   │   ├── BookingDialog.vue (预订对话框)
│   │   ├── EditRentalDialog.vue (编辑租赁对话框)
│   │   └── RentalTooltip.vue (租赁信息提示组件)
│   ├── RentalContractView.vue (租赁合同视图)
│   └── ShippingOrderView.vue (发货单视图)
└── 通用组件
    ├── ImagePreviewDialog.vue (图片预览对话框)
    └── icons/ (图标组件)
```

### 核心前端组件详解

#### 1. GanttView.vue - 甘特图主视图
**功能特性**:
- 甘特图数据管理和状态控制
- 时间导航功能（月份切换、今天定位）
- 设备过滤和搜索
- 全局布局和样式管理

**主要方法**:
- `loadGanttData()`: 加载甘特图数据
- `navigateToToday()`: 导航到今天
- `changeMonth()`: 切换月份
- `filterDevices()`: 设备过滤

#### 2. GanttChart.vue - 甘特图核心组件
**功能特性**:
- 甘特图渲染和交互
- 时间轴生成和显示
- 设备行渲染
- 租赁块的绘制和交互

**交互功能**:
- 点击空白区域添加租赁
- 点击租赁块查看/编辑详情
- 拖拽调整租赁时间（未实现）
- 滚动和缩放支持

#### 3. GanttRow.vue - 甘特图行组件
**功能特性**:
- 单个设备行的渲染
- 设备信息显示
- 租赁块的定位和样式
- 行级交互处理

#### 4. BookingDialog.vue - 预订对话框
**功能特性**:
- 新建租赁记录表单
- 客户信息输入和验证
- 设备选择和附件管理
- 档期冲突检测
- 重复租赁提醒

**表单字段**:
- 设备选择
- 客户姓名
- 客户电话
- 收件地址
- 租赁时间
- 附件选择
- 物流时间

#### 5. EditRentalDialog.vue - 编辑租赁对话框
**功能特性**:
- 租赁记录编辑
- 状态变更管理
- 物流信息更新
- 快递单号管理
- 附件修改

**编辑功能**:
- 基本信息修改
- 租赁状态变更
- 物流时间调整
- 附件增删改
- 强制更新选项

#### 6. RentalTooltip.vue - 租赁信息提示
**功能特性**:
- 鼠标悬停显示租赁详情
- 快速操作按钮
- 状态指示器
- 客户信息展示

### 状态管理 (Pinia Store)

#### Gantt Store
```typescript
interface GanttState {
  devices: Device[]
  rentals: Rental[]
  currentDate: Date
  selectedTimeRange: {
    start: Date
    end: Date
  }
  loading: boolean
  filters: {
    deviceName: string
    customerName: string
    status: string[]
  }
}
```

**主要Actions**:
- `fetchGanttData()`: 获取甘特图数据
- `createRental()`: 创建租赁记录
- `updateRental()`: 更新租赁记录
- `deleteRental()`: 删除租赁记录
- `setFilters()`: 设置过滤条件

### 路由配置
```typescript
const routes = [
  {
    path: '/',
    name: 'gantt',
    component: GanttView
  },
  {
    path: '/contract/:id',
    name: 'rental-contract',
    component: RentalContractView
  },
  {
    path: '/shipping/:id',
    name: 'shipping-order',
    component: ShippingOrderView
  }
]
```

### 前端技术特性

#### 响应式设计
- 支持桌面端和平板端访问
- 弹性布局适配不同屏幕尺寸
- 甘特图横向滚动优化

#### 性能优化
- 组件懒加载
- 虚拟滚动（大数据量甘特图）
- 防抖节流优化
- 图片懒加载

#### 用户体验
- 操作反馈和加载状态
- 错误提示和异常处理
- 键盘快捷键支持
- 拖拽操作体验

## 业务逻辑与核心功能

### 核心业务流程

#### 1. 设备租赁流程
```
设备查询 → 档期检查 → 创建租赁 → 状态管理 → 物流追踪 → 完成收回
    ↓         ↓         ↓         ↓         ↓         ↓
   可用设备   无冲突    录入信息   状态流转   快递跟踪   结算完成
```

**详细步骤**:
1. **设备查询**: 根据时间范围查询可用设备
2. **档期检查**: 检测设备在指定时间是否有冲突
3. **创建租赁**: 录入客户信息，创建租赁记录
4. **状态管理**: 管理租赁全生命周期状态
5. **物流追踪**: 集成顺丰API实现物流状态同步
6. **完成收回**: 设备收回，完成租赁流程

#### 2. 附件管理逻辑
**新架构设计**:
- 附件作为独立的租赁记录存储
- 通过 `parent_rental_id` 关联到主设备租赁
- 主设备和附件状态同步管理
- 支持附件的独立档期管理

**附件关联机制**:
```python
# 主设备租赁
main_rental = Rental(
    device_id=main_device_id,
    parent_rental_id=None,  # 主租赁
    # ... 其他字段
)

# 附件租赁
accessory_rental = Rental(
    device_id=accessory_device_id,
    parent_rental_id=main_rental.id,  # 关联主租赁
    # ... 其他字段继承自主租赁
)
```

#### 3. 档期冲突检测算法
**冲突检测逻辑**:
```python
def check_time_conflict(existing_rental, new_rental):
    """
    检测两个租赁记录的时间冲突
    使用寄出时间和收回时间进行精确检测
    """
    # 时间段重叠条件：
    # existing.ship_out_time < new.ship_in_time AND
    # existing.ship_in_time > new.ship_out_time

    return (existing.ship_out_time < new.ship_in_time and
            existing.ship_in_time > new.ship_out_time)
```

**优化策略**:
- 基于物流时间而非租赁时间检测冲突
- 支持强制创建选项
- 提供冲突详情供用户判断
- 缓存常用查询结果

#### 4. 设备优选算法
**优选策略**:
1. **最高优先级**: 无租赁历史的设备
2. **中等优先级**: 完成租赁超过24小时的设备
3. **较低优先级**: 完成租赁4-24小时的设备
4. **最低优先级**: 完成租赁不足4小时的设备

```python
def sort_available_devices(devices, query_ship_out_time):
    """设备优选排序算法"""
    for device in devices:
        latest_rental = get_latest_completed_rental(device)
        if not latest_rental:
            priority = 0  # 最高优先级
        else:
            time_gap = (query_ship_out_time - latest_rental.ship_in_time).hours
            if time_gap >= 24:
                priority = 1
            elif time_gap >= 4:
                priority = 2
            else:
                priority = 3  # 最低优先级

    return sorted(devices, key=lambda d: d.priority)
```

### 核心功能模块

#### 1. 甘特图可视化
**技术实现**:
- 基于HTML5 Canvas或SVG渲染
- 时间轴动态生成（按天/周/月）
- 设备行垂直排列
- 租赁块水平时间映射

**交互功能**:
- 时间导航（前进/后退/今天）
- 缩放级别切换
- 设备过滤和搜索
- 点击交互（新建/编辑/删除）

**性能优化**:
- 虚拟滚动支持大量设备
- 按需渲染可视区域
- 缓存计算结果
- 防抖优化交互响应

#### 2. OCR身份证识别
**集成服务**: 阿里云OCR API
**支持功能**:
- 身份证正反面识别
- 姓名、身份证号自动提取
- 地址信息识别
- 图片质量检测

**使用场景**:
- 客户信息快速录入
- 合同生成自动填充
- 身份验证辅助

#### 3. 物流追踪集成
**集成服务**: 顺丰快递API
**实现功能**:
- 自动获取快递状态
- 定时同步物流信息
- 异常状态提醒
- 签收确认自动化

**状态映射**:
```python
SF_STATUS_MAPPING = {
    "已取件": "shipped",
    "运输中": "shipped",
    "派送中": "shipped",
    "已签收": "returned"
}
```

#### 4. 合同生成系统
**技术实现**:
- Word模板 + python-docx
- 动态数据填充
- HTML转换和预览
- PDF导出支持

**合同模板变量**:
- 客户信息（姓名、电话、地址、身份证号）
- 设备信息（型号、序列号、附件清单）
- 租赁信息（时间、费用、押金）
- 物流信息（快递单号、寄出收回时间）

#### 5. 定时任务调度
**任务类型**:
- 设备状态更新检查
- 快递状态同步
- 逾期租赁提醒
- 数据备份任务

**实现技术**:
- schedule库实现任务调度
- 多进程安全机制
- 任务执行日志记录
- 异常重试机制

### 业务规则与约束

#### 1. 时间管理规则
- **寄出时间**: 默认19:00，表示当天晚上寄出
- **收回时间**: 默认次日12:00，表示第二天中午收回
- **最小租赁时长**: 1天
- **最大租赁时长**: 30天
- **提前预订**: 最少提前1天

#### 2. 设备状态管理
- **online**: 设备在线，可正常租赁
- **offline**: 设备离线，不可租赁
- 设备状态不会因租赁状态自动变化
- 支持手动状态管理

#### 3. 租赁状态流转
```
not_shipped → shipped → returned → completed
     ↓           ↓         ↓
  cancelled   cancelled   cancelled
```

**状态说明**:
- `not_shipped`: 已预订但未发货
- `shipped`: 已发货在外
- `returned`: 已收回待处理
- `completed`: 租赁完成
- `cancelled`: 租赁取消

#### 4. 附件管理规则
- 附件必须关联主设备租赁
- 附件状态与主设备同步
- 支持动态添加/删除附件
- 附件独立档期管理

## 配置文件与环境变量

### 主要配置文件

#### 1. config.py - 应用配置
```python
class Config:
    # 数据库配置
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL')
    SQLALCHEMY_TRACK_MODIFICATIONS = False

    # 应用配置
    SECRET_KEY = os.environ.get('SECRET_KEY')
    MAX_CONTENT_LENGTH = 16 * 1024 * 1024  # 16MB

    # 业务配置
    DEFAULT_RENTAL_DAYS = 7
    MAX_RENTAL_DAYS = 30
    MIN_ADVANCE_BOOKING_DAYS = 1

    # 日志配置
    LOG_LEVEL = os.environ.get('LOG_LEVEL', 'INFO')
    LOG_FILE = 'logs/inventory_service.log'
```

#### 2. requirements.txt - Python依赖
**核心依赖**:
- Flask框架生态（Flask, SQLAlchemy, Migrate, CORS）
- 数据库驱动（PyMySQL, cryptography）
- 生产服务器（Gunicorn, Gevent）
- 图像处理（Pillow）
- OCR服务（阿里云SDK）
- 文档处理（python-docx, beautifulsoup4）
- HTTP请求（requests）
- 定时任务（schedule）

#### 3. package.json - 前端依赖
**核心依赖**:
- Vue 3生态（vue, vue-router, pinia）
- UI组件（Element Plus, @element-plus/icons-vue）
- 开发工具（Vite, TypeScript, Vue TSC）
- HTTP客户端（Axios）
- 日期处理（Day.js, @vuepic/vue-datepicker）

### 环境变量配置

#### 必需环境变量
```bash
# 数据库连接
DATABASE_URL=mysql+pymysql://user:pass@host:port/db

# 应用密钥
SECRET_KEY=your-secret-key-change-in-production

# 顺丰快递API
SF_PARTNER_ID=your_partner_id
SF_CHECKWORD=your_checkword
SF_TEST_MODE=true

# 阿里云OCR
ALIBABA_CLOUD_ACCESS_KEY_ID=your_access_key_id
ALIBABA_CLOUD_ACCESS_KEY_SECRET=your_access_key_secret
ALIBABA_CLOUD_OCR_ENDPOINT=ocr-api.cn-hangzhou.aliyuncs.com
```

#### 可选环境变量
```bash
# 应用配置
APP_PORT=5002
FLASK_ENV=production
LOG_LEVEL=INFO
TZ=Asia/Shanghai

# 跨域配置
CORS_ORIGINS=*

# 缓存配置
CACHE_TYPE=simple
CACHE_DEFAULT_TIMEOUT=300

# 文件上传
MAX_CONTENT_LENGTH=16777216
UPLOAD_FOLDER=uploads
```

### 环境配置文件
系统提供多个环境模板：
- `env.example`: 完整配置参考
- `env.local`: 本地开发环境
- `env.production`: 生产环境
- `env.docker`: Docker环境

### Docker配置

#### docker-compose.yml
**服务组件**:
- **mysql**: MySQL 8.0数据库
- **redis**: Redis 7缓存服务
- **app**: 主应用服务
- **nginx**: 反向代理服务

**卷挂载**:
- `mysql_data`: 数据库数据持久化
- `redis_data`: Redis数据持久化
- `app_logs`: 应用日志
- `app_uploads`: 文件上传存储

#### Dockerfile
**特性**:
- 多架构支持（ARM64 + AMD64）
- 非root用户运行
- 健康检查配置
- 生产级Gunicorn配置
- 分层优化构建

## 部署与运维

### 部署方式

#### 1. Docker部署（推荐）
```bash
# 克隆项目
git clone <repository-url>
cd InventoryManager

# 配置环境变量
cp env.docker .env
# 编辑.env文件

# 启动服务
docker-compose up -d

# 查看服务状态
docker-compose ps
```

#### 2. Makefile部署
```bash
# 查看可用命令
make help

# 开发环境启动
make dev

# Docker环境启动
make docker-dev

# 生产环境部署
make deploy
```

#### 3. 手动部署
```bash
# 安装依赖
pip install -r requirements.txt

# 配置数据库
mysql -u root -p
CREATE DATABASE inventory_management;

# 初始化数据库
python init_db.py

# 启动服务
python app.py
```

### 系统监控

#### 健康检查
- **应用健康检查**: `/health` 端点
- **数据库连接检查**: MySQL连接状态
- **缓存服务检查**: Redis连接状态
- **容器健康检查**: Docker healthcheck

#### 日志管理
```python
# 日志配置
LOG_CONFIG = {
    'app_log': 'logs/inventory_service.log',
    'access_log': 'logs/access.log',
    'error_log': 'logs/error.log',
    'rotation': '10MB',
    'backup_count': 5
}
```

#### 性能监控
- **响应时间监控**: API响应时间统计
- **数据库性能**: 连接池状态监控
- **缓存命中率**: Redis缓存效率
- **资源使用率**: CPU、内存、磁盘使用

### 备份与恢复

#### 数据备份策略
```bash
# 数据库备份
mysqldump -u user -p inventory_management > backup.sql

# 文件备份
tar -czf uploads_backup.tar.gz uploads/

# 配置备份
cp .env .env.backup
```

#### 恢复流程
```bash
# 数据库恢复
mysql -u user -p inventory_management < backup.sql

# 文件恢复
tar -xzf uploads_backup.tar.gz

# 重启服务
docker-compose restart
```

### 扩展性考虑

#### 水平扩展
- **负载均衡**: Nginx反向代理多实例
- **数据库读写分离**: 主从复制配置
- **缓存集群**: Redis集群模式
- **文件存储**: 对象存储服务

#### 性能优化
- **数据库优化**: 索引优化、查询优化
- **缓存策略**: 多级缓存、缓存预热
- **前端优化**: CDN加速、资源压缩
- **代码优化**: 异步处理、连接池

## 安全考虑

### 数据安全
- **数据库安全**: 用户权限控制、连接加密
- **API安全**: 请求验证、参数过滤
- **文件安全**: 上传文件类型检查、存储隔离
- **敏感信息**: 环境变量管理、密钥轮换

### 网络安全
- **HTTPS加密**: 生产环境强制HTTPS
- **CORS策略**: 跨域请求控制
- **防火墙**: 端口访问控制
- **DDoS防护**: 请求频率限制

### 运行安全
- **容器安全**: 非root用户运行
- **权限控制**: 最小权限原则
- **日志审计**: 操作日志记录
- **异常监控**: 异常行为检测

## 开发与维护

### 开发环境搭建
```bash
# 1. 克隆项目
git clone <repository-url>
cd InventoryManager

# 2. 后端环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt

# 3. 前端环境
cd frontend
npm install
npm run dev

# 4. 数据库初始化
python init_db.py

# 5. 启动开发服务
python app.py
```

### 代码规范
- **Python**: PEP 8代码规范
- **JavaScript/TypeScript**: ESLint + Prettier
- **Git**: 语义化提交信息
- **文档**: 中文注释和文档

### 测试策略
- **单元测试**: pytest框架
- **集成测试**: API接口测试
- **前端测试**: Vue Test Utils
- **E2E测试**: 关键业务流程测试

### 版本管理
- **语义化版本**: 主版本.次版本.修订版本
- **分支策略**: Git Flow工作流
- **发布管理**: 自动化部署脚本
- **回滚机制**: 快速回滚方案

## 项目文档结构

### 技术文档
- `README.md`: 项目基本介绍
- `INSTALL.md`: 安装说明
- `API.md`: API接口文档
- `DEPLOY.md`: 部署指南

### 业务文档
- `docs/需求.md`: 业务需求说明
- `docs/rental_status_说明.md`: 租赁状态说明
- `docs/修复总结.md`: 问题修复记录

### 开发文档
- `docs/代码重构总结.md`: 重构记录
- `docs/模块重构说明.md`: 模块设计说明
- `docs/数据库迁移说明.md`: 数据库变更记录

### 运维文档
- `docs/启动说明.md`: 服务启动指南
- `docs/环境变量配置说明.md`: 环境配置说明
- `docs/Makefile使用说明.md`: 构建工具说明

## 总结

库存管理系统（InventoryManager）是一个功能完整、架构清晰的企业级应用，具备以下特点：

### 技术优势
1. **现代化技术栈**: Vue3 + Flask + MySQL的主流组合
2. **容器化部署**: Docker + Docker Compose实现一键部署
3. **前后端分离**: 清晰的架构边界，便于维护和扩展
4. **多环境支持**: 开发/测试/生产环境配置分离

### 功能完整性
1. **核心业务**: 设备租赁管理、甘特图可视化
2. **辅助功能**: OCR识别、物流追踪、合同生成
3. **系统功能**: 审计日志、定时任务、健康检查
4. **用户体验**: 直观界面、交互友好、响应迅速

### 可扩展性
1. **水平扩展**: 支持负载均衡和集群部署
2. **功能扩展**: 模块化设计便于新功能开发
3. **集成能力**: RESTful API支持第三方系统集成
4. **数据迁移**: 完整的数据库迁移机制

### 维护性
1. **代码质量**: 规范的代码结构和注释
2. **文档完善**: 全面的技术和业务文档
3. **监控体系**: 日志记录和健康检查
4. **版本管理**: Git版本控制和发布流程

该系统能够满足手机租赁业务的全流程管理需求，为企业提供高效、可靠的库存管理解决方案。
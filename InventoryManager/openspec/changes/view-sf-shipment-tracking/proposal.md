# 顺丰物流追踪查询页面

## Why

当前系统支持批量发货功能,用户可以通过批量发货流程为租赁订单下顺丰快递单。然而,发货后缺少统一的查询入口来查看:
1. 通过批量发货下了哪些顺丰单
2. 每个顺丰单对应的租赁信息(客户、设备、地址等)
3. 每个顺丰单的实时物流状态和轨迹

用户只能在甘特图中逐个打开租赁记录查看运单号,无法整体掌握批量发货的物流状态。这在需要追踪多个订单时效率低下,特别是当客户询问物流进度时,无法快速响应。

本提案增加一个专门的"顺丰物流追踪"页面,可以:
- 查看所有已录入顺丰运单号的租赁订单列表
- 查看每个订单的租赁信息和运单号
- 通过顺丰接口实时拉取物流轨迹信息
- 在首页导航栏添加入口链接

## What Changes

### 用户体验改进
- **首页导航栏**:添加"顺丰物流"链接,指向新的追踪页面
- **物流追踪页面**:显示所有已录入运单号的租赁订单表格
  - 表格列:租赁ID、客户姓名、客户电话、目的地、设备名称、运单号、发货时间、物流状态
  - 点击"查看轨迹"按钮,展开该订单的详细物流轨迹
  - 支持按日期范围筛选订单
  - 支持批量刷新物流状态
- **物流轨迹详情**:展示顺丰返回的路由信息
  - 时间轴展示各个物流节点
  - 显示操作时间、操作地点、操作备注
  - 显示当前物流状态(已揽收、运输中、派送中、已签收等)

### 技术实现
- **后端 API**:
  - `GET /api/sf-tracking/list`:查询所有有运单号的租赁订单列表
    - 支持日期范围筛选参数 `start_date`, `end_date`
    - 返回租赁基本信息和运单号
  - `POST /api/sf-tracking/query`:查询单个运单的物流轨迹
    - 调用 `SFExpressSDK.search_routes()` 获取路由信息
    - 调用 `SFExpressSDK.parse_route_response()` 解析路由状态
  - `POST /api/sf-tracking/batch-query`:批量查询多个运单物流信息
    - 调用 `SFExpressSDK.batch_search_routes()` 批量查询
    - 最多支持100个运单号(顺丰API限制)

- **前端页面**:
  - 创建 `SFTrackingView.vue` 组件
  - 复用现有 SF SDK 的物流查询能力
  - 使用 Element Plus 或 Bootstrap Vue 表格组件
  - 集成现有的路由解析逻辑

- **路由配置**:
  - 添加路由 `/sf-tracking` 指向物流追踪页面
  - 在 `web_pages.py` 添加对应的路由处理

## Impact

### 用户影响
- **效率提升**:集中查看所有顺丰订单,无需在甘特图中逐个查找
- **客户服务**:快速响应客户物流查询,提升客户满意度
- **状态掌控**:实时了解批量发货的整体物流进度
- **问题发现**:及时发现异常物流状态(如长时间未更新)

### 系统影响
- **性能**:
  - 列表查询:轻量级数据库查询,性能影响小
  - 单次物流查询:调用顺丰API,响应时间约1-2秒
  - 批量查询:受顺丰API限制,最多100单,可能需要5-10秒
- **API调用频率**:新增顺丰API调用,建议添加缓存机制避免频繁调用
- **兼容性**:复用现有 SF SDK,无破坏性变更

### 风险评估
- **API限制**:顺丰API可能有调用频率限制,需要错误处理和重试机制
- **数据一致性**:需要确保 `ship_out_tracking_no` 字段数据质量
- **隐私保护**:客户姓名、电话等敏感信息需要访问控制
- **成本**:顺丰API调用是否收费需要确认

## Alternatives Considered

### 方案 1:在甘特图中增加物流状态列
- **优点**:无需新页面,直接在现有界面查看
- **缺点**:甘特图聚焦时间维度,物流信息会使界面过于复杂
- **结论**:未选择,职责分离更清晰

### 方案 2:在批量发货页面增加物流追踪标签页
- **优点**:功能集中在批量发货流程中
- **缺点**:批量发货页面已有多个功能,增加标签页会降低性能
- **结论**:未选择,独立页面更灵活

### 方案 3:使用第三方物流聚合平台
- **优点**:支持多家快递公司,功能更全面
- **缺点**:增加第三方依赖,可能产生额外费用,当前只用顺丰
- **结论**:未选择,当前需求简单,直接调用顺丰API即可

## Dependencies

- 依赖现有 `SFExpressSDK` 的 `search_routes()` 和 `batch_search_routes()` 方法
- 依赖现有 `Rental` 模型的 `ship_out_tracking_no` 和 `customer_phone` 字段
- 依赖顺丰 API 的路由查询接口 `EXP_RECE_SEARCH_ROUTES`
- 需要顺丰API凭证配置正确(SF_PARTNER_ID, SF_CHECKWORD)
- 需要收件人或寄件人手机号后四位作为验证参数

## Questions & Clarifications

### 需要用户确认的问题
1. **筛选范围**:是否只显示最近N天的订单,还是显示所有历史订单?
显示最近过去4 天+未来 4 天的就足够
2. **缓存策略**:物流信息是否需要缓存?缓存多久更新一次?
不需要缓存，每次刷新实际查询
3. **权限控制**:该页面是否需要登录或权限验证?
不需要
4. **通知功能**:是否需要在物流状态变化时发送通知(如已签收)?
不需要通知
5. **导出功能**:是否需要导出物流信息为Excel或PDF?
不需要导出

### 技术细节待明确
1. 顺丰API `search_routes` 需要手机号后四位,是用客户手机号还是寄件人手机号?
用寄件人手机号13510224947
2. 批量查询时,如果部分运单号查询失败,如何处理?
页面展示查询失败，跳过，继续查询剩下的
3. 物流信息是否需要存储到数据库,还是每次实时查询?
实时查询

## Rollout Plan

### Phase 1:MVP 核心功能
1. 创建后端 API:查询有运单号的租赁列表
2. 创建后端 API:单个运单物流查询
3. 创建前端页面:显示订单列表
4. 创建前端组件:物流轨迹详情展示
5. 在首页添加导航链接

### Phase 2:优化增强
1. 添加日期范围筛选
2. 实现批量查询功能
3. 添加物流状态缓存机制
4. 添加自动刷新功能
5. 改进错误处理和加载状态

### Phase 3:高级功能(可选)
1. 物流状态变化通知
2. 异常物流告警
3. 导出物流报表
4. 物流统计分析

### 测试策略
- **单元测试**:API路由参数验证、顺丰SDK调用
- **集成测试**:完整查询流程、批量查询
- **手动测试**:实际查询真实运单号的物流信息
- **边界测试**:无运单号订单、查询失败、API超时

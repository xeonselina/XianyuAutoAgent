# Proposal: Interleave Shipping Slips with Waybills

## Overview
在批量打印快递面单时,每打印一张面单后立即打印一张精简的发货单,实现面单和发货单在快麦打印机上交替打印。这样可以确保每个包裹都有配套的发货单,方便装箱和核对。

## Why
目前的批量打印流程存在以下问题:

1. **面单和发货单分离**: 面单通过快麦云打印机打印,发货单需要单独在Chrome浏览器中打印
2. **装箱效率低**: 打印完所有面单后,需要逐个匹配对应的发货单,容易出错
3. **流程繁琐**: 需要在两个不同的系统间切换(快麦云打印 + Chrome打印)
4. **容易遗漏**: 分别打印时可能忘记打印某些订单的发货单

通过在快麦打印机上交替打印面单和发货单,可以:
- ✅ **一次性完成**: 一键完成所有面单和发货单的打印
- ✅ **自然配对**: 每张面单后紧跟对应的发货单,无需手动匹配
- ✅ **减少错误**: 消除匹配错误和遗漏的可能性
- ✅ **提升效率**: 打印完成即可直接装箱发货

## Problem Statement
当前批量打印面单流程:
```
用户选择日期范围 → 批量获取顺丰面单 → 转换PDF为图像 → 发送到快麦打印
```

缺少发货单打印环节,导致:
1. 用户需要单独打印发货单(通过Chrome浏览器)
2. 打印后需要手动匹配面单和发货单
3. 无法保证每个包裹都有发货单

## Proposed Solution
在现有批量打印面单流程中插入发货单打印步骤:

```
对于每个租赁记录:
  1. 获取顺丰面单PDF并转换为图像
  2. 发送面单图像到快麦打印机
  3. 生成精简发货单图像
  4. 发送发货单图像到快麦打印机
```

### 精简发货单设计
为了适配快麦打印机(80mm宽热敏纸),发货单需要精简为以下信息:

**必要信息**:
- 订单识别码(条形码)
- 买家ID/收货人姓名
- 收货电话
- 收货地址
- 设备名称 + 序列号
- 主要附件说明
- 租赁起止日期
- 归还截止时间

**省略信息**(相比完整发货单):
- 公司Logo(节省空间)
- 详细的附件列表(仅保留关键附件)
- 寄回地址信息(已在快递面单上)
- 装饰性图标和边框

### 技术实现方案
1. **创建精简发货单模板**:
   - 新建 `SimplifiedShippingSlipTemplate.vue` 组件
   - 设计80mm宽度的简洁布局
   - 使用条形码库生成订单识别码

2. **渲染为图像**:
   - 使用 `html2canvas` 将Vue组件渲染为Canvas
   - 将Canvas转换为PNG格式的base64图像
   - 调整DPI以适配快麦打印机(203 DPI)

3. **集成到打印流程**:
   - 修改 `WaybillPrintService.print_single_waybill()` 方法
   - 在打印完面单后,调用发货单生成API
   - 将发货单图像发送到快麦打印机

## Success Criteria
1. 批量打印时,每张面单后自动跟随一张发货单
2. 发货单内容精简但包含所有必要信息
3. 发货单图像清晰,条形码可扫描
4. 打印顺序正确且稳定(面单 → 发货单 → 面单 → ...)
5. 打印失败时有明确的错误提示
6. 不影响单独打印面单的功能

## Scope

### In Scope
- 创建精简发货单Vue组件
- 实现组件到图像的转换逻辑
- 修改批量打印流程以交替打印面单和发货单
- 添加发货单图像生成API端点
- 确保条形码可正确生成和扫描

### Out of Scope
- 修改现有完整发货单模板(保持现状)
- 支持自定义发货单模板
- 发货单打印历史记录
- 允许用户跳过发货单打印
- 支持其他打印机品牌

## Dependencies
- **现有组件**: `ShippingOrderView.vue` (发货单模板参考)
- **服务**: `WaybillPrintService`, `KuaimaiPrintService`
- **库**: JsBarcode (条形码生成), html2canvas (组件渲染)
- **环境**: 快麦云打印机配置和连接

## Risks & Mitigations

**风险1**: 发货单图像生成失败
**缓解措施**:
- 添加图像生成失败时的重试逻辑
- 失败时跳过该订单的发货单,继续打印其他订单
- 记录失败的租赁ID,供用户后续补打

**风险2**: 打印顺序混乱
**缓解措施**:
- 使用同步打印API调用,确保按顺序发送
- 在发送下一个打印任务前,等待上一个任务返回jobId
- 添加详细的日志记录每个打印任务的状态

**风险3**: 快麦打印机限流或超时
**缓解措施**:
- 批量打印时在每个打印任务间添加短暂延迟(200-500ms)
- 检测API限流响应,自动等待后重试
- 设置合理的超时时间和重试次数上限

**风险4**: 发货单图像质量不佳或条形码无法扫描
**缓解措施**:
- 在开发阶段进行充分测试,调整图像DPI和尺寸
- 使用高质量的条形码生成库
- 预留条形码周围的空白区域,提高扫描成功率

## Alternatives Considered

### 方案1: 发货单也通过浏览器打印
- **优点**: 无需开发图像转换逻辑,使用现有打印流程
- **缺点**: 无法实现交替打印,仍需手动匹配
- **结论**: 未选择,无法解决核心问题

### 方案2: 将发货单内容嵌入面单PDF
- **优点**: 一张PDF包含所有信息
- **缺点**: 需要修改顺丰面单模板(不可行),且信息过于拥挤
- **结论**: 未选择,技术上不可行

### 方案3: 生成包含发货单的CPCL指令
- **优点**: 直接生成打印指令,无需图像转换
- **缺点**: 需要学习CPCL指令集,开发复杂度高,不易维护
- **结论**: 未选择,优先使用更简单的图像方案

## Rollout Plan

### Phase 1: 精简发货单模板开发
1. 创建 `SimplifiedShippingSlipTemplate.vue` 组件
2. 设计80mm宽度布局,包含所有必要信息
3. 集成条形码生成功能

### Phase 2: 图像转换功能
1. 实现组件渲染为Canvas的工具函数
2. 将Canvas转换为base64图像
3. 调整图像参数以适配快麦打印机

### Phase 3: 后端API开发
1. 创建发货单图像生成API端点
2. 接收租赁ID,返回base64图像
3. 添加错误处理和日志记录

### Phase 4: 集成到批量打印流程
1. 修改 `WaybillPrintService` 以支持交替打印
2. 在打印每张面单后调用发货单生成和打印
3. 确保打印顺序正确

### Phase 5: 测试和优化
1. 测试单张和批量打印场景
2. 验证条形码可扫描性
3. 优化图像质量和打印速度
4. 测试错误处理和重试逻辑

## Technical Notes
- 发货单组件应独立于现有完整发货单,避免相互影响
- 图像转换应在后端进行,避免前端性能问题
- 快麦打印机API调用应添加合理的超时和重试机制
- 条形码格式建议使用 Code128,兼容性好且信息密度高

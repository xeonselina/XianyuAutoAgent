# Proposal: 批量发货选择顺丰快递类型

## Change ID
`select-sf-express-type`

## Status
Draft

## Summary
在批量发货页面的订单列表中,为每个订单增加顺丰快递类型选择器,允许用户为每个订单选择不同的快递服务类型(特快/标快/半日达),下单时使用选中的类型调用顺丰API。

## Motivation
当前批量发货功能在调用顺丰API下单时,所有订单都使用固定的快递类型(`expressTypeId=1`),无法根据客户需求或时效要求选择不同的快递服务。用户需要能够为不同订单选择合适的快递类型:
- 特快(expressTypeId=1):时效最快,成本最高
- 标快(expressTypeId=2):标准时效,性价比高(默认推荐)
- 半日达(expressTypeId=6):当日/次日达,适合本地配送

## User Impact
**受益用户:**
- 操作人员:可以根据客户需求、订单紧急程度灵活选择快递类型
- 客户:可以获得更符合需求的快递服务时效

**变更影响:**
- 批量发货页面UI会增加一列"快递类型"选择器
- 默认选择"标快",用户可手动更改
- 不影响现有运单号录入、预约发货等功能

## Proposed Changes

### 1. 数据库变更
在 `rentals` 表中增加字段 `express_type_id`:
- 类型: `INTEGER`
- 默认值: `2` (标快)
- 可选值: `1`(特快), `2`(标快), `6`(半日达)
- 用途: 存储用户为该订单选择的快递类型

### 2. 前端变更 (BatchShippingView.vue)
在订单列表表格中增加一列"快递类型":
- 使用下拉选择器(el-select)显示三个选项
- 默认值为"标快"(expressTypeId=2)
- 选择变更后立即调用API更新数据库
- 选项显示格式: "特快" / "标快" / "半日达"

### 3. 后端变更
**API层 (shipping_batch_api.py):**
- 新增 `PATCH /api/shipping-batch/express-type` 端点
- 接收 `rental_id` 和 `express_type_id` 参数
- 验证 `express_type_id` 在 `[1, 2, 6]` 范围内
- 更新数据库中对应租赁记录的 `express_type_id` 字段

**模型层 (rental.py):**
- 在 `Rental` 模型中增加 `express_type_id` 字段定义

**服务层 (sf_express_service.py):**
- 修改 `place_shipping_order()` 方法
- 从 `rental.express_type_id` 读取快递类型(如果为空则默认使用2)
- 将该值传递给顺丰API的 `expressTypeId` 参数

## Alternatives Considered
1. **全局配置快递类型**: 所有订单使用统一的快递类型
   - ❌ 不够灵活,无法满足不同订单的差异化需求

2. **在预约发货时选择**: 在预约发货对话框中为所有订单批量选择快递类型
   - ❌ 无法为每个订单独立设置

3. **自动根据地址判断**: 根据收货地址自动选择快递类型
   - ❌ 复杂度高,可能不准确,用户更希望手动控制

## Implementation Complexity
**复杂度: 低**

- 数据库迁移: 简单(增加一个字段)
- 前端改动: 小(在现有表格中增加一列下拉选择器)
- 后端改动: 小(增加一个API端点,修改一个函数参数)
- 测试工作量: 低(主要测试选择器交互和API调用)

## Dependencies
- 依赖现有的批量发货功能
- 依赖顺丰API的 `expressTypeId` 参数支持

## Risks
1. **数据迁移风险**: 现有租赁记录没有 `express_type_id` 字段
   - 缓解: 使用默认值2(标快),兼容现有数据

2. **用户误操作风险**: 用户可能不小心选错快递类型
   - 缓解: 设置合理默认值(标快),在UI上突出显示当前选择

## Open Questions
1. ✅ **默认值选择**: 使用"标快"(expressTypeId=2)作为默认值是否合理?
   - 回答: 合理,标快是性价比最高的选项

2. ✅ **是否需要批量修改**: 是否需要提供"批量设置快递类型"功能?
   - 回答: 不需要

3. ✅ **历史数据处理**: 已发货的订单是否需要回填 `express_type_id` 字段?
   - 回答: 不需要,仅对未来订单有效,历史订单使用默认值

## Success Criteria
- ✅ 批量发货页面显示"快递类型"列,默认值为"标快"
- ✅ 用户可以为每个订单独立选择快递类型
- ✅ 选择后立即保存到数据库
- ✅ 预约发货时,顺丰API使用用户选择的快递类型
- ✅ 已存在的租赁记录使用默认值(标快)

## Timeline
估计开发时间: 2-4小时
- 数据库迁移: 30分钟
- 后端API开发: 1小时
- 前端UI开发: 1-2小时
- 测试验证: 30分钟

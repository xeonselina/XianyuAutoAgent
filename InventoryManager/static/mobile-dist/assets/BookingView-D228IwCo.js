import{d as A,t as O,c as H,r as b,L as ve,M as oe,a as l,w as K,k as F,N as pe,O as ge,q,P as _e,n as ae,Q as Be,p as be,e as ye,R as we,o as le,l as he,S as Ce,m as De,U as ke,V as J,W as Ve,X as Se,Y as Pe,Z as Ye,_ as xe,s as Te,v as Ee,x as Q,D as S,J as X,B as Z,E as ee,G as N,$ as Me,z as L}from"./index-BFtJC-91.js";import{b as se,B as I,p as Oe,P as re,h as $e,m as Ae,i as Fe,c as Ue,d as w,N as Ne,C as Re,F as qe,j as Ie,D as He,s as x,k as Ke,l as je,_ as Le}from"./_plugin-vue_export-helper-BI-CNIVu.js";const[ie,te]=H("action-bar"),ue=Symbol(ie),ze={placeholder:Boolean,safeAreaInsetBottom:O};var We=A({name:ie,props:ze,setup(o,{slots:v}){const u=b(),t=ve(u,te),{linkChildren:m}=oe(ue);m();const p=()=>{var g;return l("div",{ref:u,class:[te(),{"van-safe-area-bottom":o.safeAreaInsetBottom}]},[(g=v.default)==null?void 0:g.call(v)])};return()=>o.placeholder?t(p):p()}});const Ge=K(We),[Je,Qe]=H("action-bar-button"),Xe=F({},_e,{type:String,text:String,icon:String,color:String,loading:Boolean,disabled:Boolean});var Ze=A({name:Je,props:Xe,setup(o,{slots:v}){const u=pe(),{parent:t,index:m}=ge(ue),p=q(()=>{if(t){const f=t.children[m.value-1];return!(f&&"isButton"in f)}}),g=q(()=>{if(t){const f=t.children[m.value+1];return!(f&&"isButton"in f)}});return se({isButton:!0}),()=>{const{type:f,icon:y,text:_,color:h,loading:C,disabled:k}=o;return l(I,{class:Qe([f,{last:g.value,first:p.value}]),size:"large",type:f,icon:y,color:h,loading:C,disabled:k,onClick:u},{default:()=>[v.default?v.default():_]})}}});const ne=K(Ze),[et,tt]=H("form"),nt={colon:Boolean,disabled:Boolean,readonly:Boolean,required:[Boolean,String],showError:Boolean,labelWidth:ae,labelAlign:String,inputAlign:String,scrollToError:Boolean,scrollToErrorPosition:String,validateFirst:Boolean,submitOnEnter:O,showErrorMessage:O,errorMessageAlign:String,validateTrigger:{type:[String,Array],default:"onBlur"}};var ot=A({name:et,props:nt,emits:["submit","failed"],setup(o,{emit:v,slots:u}){const{children:t,linkChildren:m}=oe(Be),p=a=>a?t.filter(n=>a.includes(n.name)):t,g=a=>new Promise((n,r)=>{const d=[];p(a).reduce((Y,E)=>Y.then(()=>{if(!d.length)return E.validate().then(U=>{U&&d.push(U)})}),Promise.resolve()).then(()=>{d.length?r(d):n()})}),f=a=>new Promise((n,r)=>{const d=p(a);Promise.all(d.map(c=>c.validate())).then(c=>{c=c.filter(Boolean),c.length?r(c):n()})}),y=a=>{const n=t.find(r=>r.name===a);return n?new Promise((r,d)=>{n.validate().then(c=>{c?d(c):r()})}):Promise.reject()},_=a=>typeof a=="string"?y(a):o.validateFirst?g(a):f(a),h=a=>{typeof a=="string"&&(a=[a]),p(a).forEach(r=>{r.resetValidation()})},C=()=>t.reduce((a,n)=>(a[n.name]=n.getValidationStatus(),a),{}),k=(a,n)=>{t.some(r=>r.name===a?(r.$el.scrollIntoView(n),!0):!1)},P=()=>t.reduce((a,n)=>(n.name!==void 0&&(a[n.name]=n.formValue.value),a),{}),T=()=>{const a=P();_().then(()=>v("submit",a)).catch(n=>{v("failed",{values:a,errors:n});const{scrollToError:r,scrollToErrorPosition:d}=o;r&&n[0].name&&k(n[0].name,d?{block:d}:void 0)})},M=a=>{be(a),T()};return m({props:o}),se({submit:T,validate:_,getValues:P,scrollToField:k,resetValidation:h,getValidationStatus:C}),()=>{var a;return l("form",{class:tt(),onSubmit:M},[(a=u.default)==null?void 0:a.call(u)])}}});const at=K(ot),[lt,D,R]=H("dialog"),st=F({},$e,{title:String,theme:String,width:ae,message:[String,Function],callback:Function,allowHtml:Boolean,className:ke,transition:De("van-dialog-bounce"),messageAlign:String,closeOnPopstate:O,showCancelButton:Boolean,cancelButtonText:String,cancelButtonColor:String,cancelButtonDisabled:Boolean,confirmButtonText:String,confirmButtonColor:String,confirmButtonDisabled:Boolean,showConfirmButton:O,closeOnClickOverlay:Boolean,keyboardEnabled:O,destroyOnClose:Boolean}),rt=[...Oe,"transition","closeOnPopstate","destroyOnClose"];var de=A({name:lt,props:st,emits:["confirm","cancel","keydown","update:show"],setup(o,{emit:v,slots:u}){const t=b(),m=ye({confirm:!1,cancel:!1}),p=n=>v("update:show",n),g=n=>{var r;p(!1),(r=o.callback)==null||r.call(o,n)},f=n=>()=>{o.show&&(v(n),o.beforeClose?(m[n]=!0,Ye(o.beforeClose,{args:[n],done(){g(n),m[n]=!1},canceled(){m[n]=!1}})):g(n))},y=f("cancel"),_=f("confirm"),h=we(n=>{var r,d;if(!o.keyboardEnabled||n.target!==((d=(r=t.value)==null?void 0:r.popupRef)==null?void 0:d.value))return;({Enter:o.showConfirmButton?_:J,Escape:o.showCancelButton?y:J})[n.key](),v("keydown",n)},["enter","esc"]),C=()=>{const n=u.title?u.title():o.title;if(n)return l("div",{class:D("header",{isolated:!o.message&&!u.default})},[n])},k=n=>{const{message:r,allowHtml:d,messageAlign:c}=o,Y=D("message",{"has-title":n,[c]:c}),E=Ve(r)?r():r;return d&&typeof E=="string"?l("div",{class:Y,innerHTML:E},null):l("div",{class:Y},[E])},P=()=>{if(u.default)return l("div",{class:D("content")},[u.default()]);const{title:n,message:r,allowHtml:d}=o;if(r){const c=!!(n||u.title);return l("div",{key:d?1:0,class:D("content",{isolated:!c})},[k(c)])}},T=()=>l("div",{class:[Pe,D("footer")]},[o.showCancelButton&&l(I,{size:"large",text:o.cancelButtonText||R("cancel"),class:D("cancel"),style:{color:o.cancelButtonColor},loading:m.cancel,disabled:o.cancelButtonDisabled,onClick:y},null),o.showConfirmButton&&l(I,{size:"large",text:o.confirmButtonText||R("confirm"),class:[D("confirm"),{[Se]:o.showCancelButton}],style:{color:o.confirmButtonColor},loading:m.confirm,disabled:o.confirmButtonDisabled,onClick:_},null)]),M=()=>l(Ge,{class:D("footer")},{default:()=>[o.showCancelButton&&l(ne,{type:"warning",text:o.cancelButtonText||R("cancel"),class:D("cancel"),color:o.cancelButtonColor,loading:m.cancel,disabled:o.cancelButtonDisabled,onClick:y},null),o.showConfirmButton&&l(ne,{type:"danger",text:o.confirmButtonText||R("confirm"),class:D("confirm"),color:o.confirmButtonColor,loading:m.confirm,disabled:o.confirmButtonDisabled,onClick:_},null)]}),a=()=>u.footer?u.footer():o.theme==="round-button"?M():T();return()=>{const{width:n,title:r,theme:d,message:c,className:Y}=o;return l(re,le({ref:t,role:"dialog",class:[D([d]),Y],style:{width:Ce(n)},tabindex:0,"aria-labelledby":r||c,onKeydown:h,"onUpdate:show":p},he(o,rt)),{default:()=>[C(),P(),a()]})}}});let z;const it={title:"",width:"",theme:null,message:"",overlay:!0,callback:null,teleport:"body",className:"",allowHtml:!1,lockScroll:!0,transition:void 0,beforeClose:null,overlayClass:"",overlayStyle:void 0,messageAlign:"",cancelButtonText:"",cancelButtonColor:null,cancelButtonDisabled:!1,confirmButtonText:"",confirmButtonColor:null,confirmButtonDisabled:!1,showConfirmButton:!0,showCancelButton:!1,closeOnPopstate:!0,closeOnClickOverlay:!1,destroyOnClose:!1};let ut=F({},it);function dt(){({instance:z}=Ae({setup(){const{state:v,toggle:u}=Fe();return()=>l(de,le(v,{"onUpdate:show":u}),null)}}))}function ce(o){return xe?new Promise((v,u)=>{z||dt(),z.open(F({},ut,o,{callback:t=>{(t==="confirm"?v:u)(t)}}))}):Promise.resolve(void 0)}const ct=o=>ce(F({showCancelButton:!0},o));K(de);const mt={class:"booking-view"},ft={class:"booking-content"},vt={class:"submit-container"},pt=A({__name:"BookingView",setup(o){const v=Me(),u=Ue(),t=b({device_id:null,start_date:"",end_date:"",customer_name:"",customer_phone:"",destination:"",xianyu_order_no:"",order_amount:void 0}),m=b(!1),p=b(!1),g=b(!1),f=b(!1),y=b(""),_=b(""),h=b(""),C=b(""),k=b([]),P=b([]),T=new Date(2020,0,1),M=new Date(2030,11,31);Te(()=>{u.loadDevices();const i=w();k.value=[i.format("YYYY"),i.format("MM"),i.format("DD")],P.value=[i.add(7,"day").format("YYYY"),i.add(7,"day").format("MM"),i.add(7,"day").format("DD")]});const a=q(()=>u.allDevices.find(i=>i.id===t.value.device_id)),n=q(()=>u.allDevices.filter(i=>!i.is_accessory&&i.status==="online").map(i=>({text:`${i.name} (${i.model})`,value:i.id}))),r=({selectedOptions:i})=>{const e=i[0];t.value.device_id=e.value,y.value=e.text,p.value=!1},d=({selectedValues:i})=>{const e=i.join("-");if(t.value.start_date=e,_.value=w(e).format("YYYY-MM-DD"),g.value=!1,t.value.end_date&&w(t.value.end_date).isBefore(w(e))){const V=w(e).add(7,"day");t.value.end_date=V.format("YYYY-MM-DD"),h.value=V.format("YYYY-MM-DD"),P.value=[V.format("YYYY"),V.format("MM"),V.format("DD")]}},c=({selectedValues:i})=>{const e=i.join("-");if(t.value.start_date&&w(e).isBefore(w(t.value.start_date))){x({message:"结束日期不能早于开始日期",position:"top"});return}t.value.end_date=e,h.value=w(e).format("YYYY-MM-DD"),f.value=!1},Y=()=>{if(!t.value.start_date||!t.value.end_date)return 0;const i=w(t.value.start_date);return w(t.value.end_date).diff(i,"day")+1},E=async()=>{if(!t.value.device_id){x({message:"请选择设备",position:"top"});return}if(!t.value.start_date||!t.value.end_date){x({message:"请选择租赁日期",position:"top"});return}if(!t.value.customer_name){x({message:"请输入客户名称",position:"top"});return}if(!t.value.customer_phone){x({message:"请输入联系电话",position:"top"});return}if(!t.value.destination){x({message:"请输入目的地",position:"top"});return}C.value&&(t.value.order_amount=parseFloat(C.value)),m.value=!0;try{const i=w(t.value.start_date).subtract(2,"day").hour(9).minute(0).format("YYYY-MM-DD HH:mm:ss"),e=w(t.value.end_date).add(2,"day").hour(18).minute(0).format("YYYY-MM-DD HH:mm:ss"),V=await Ke({device_id:t.value.device_id,ship_out_time:i,ship_in_time:e});if(V.success&&V.data.has_conflicts&&!await ct({title:"检测到冲突",message:"该设备在选定的时间段内已有租赁记录,是否继续创建?"})){m.value=!1;return}const B=await je(t.value);if(B.success)ce({title:"成功",message:"租赁创建成功!"}).then(()=>{u.refreshData(),v.push("/gantt")});else throw new Error(B.error||"创建租赁失败")}catch(i){x({message:i.message||"创建失败,请重试",position:"top"}),console.error("Failed to create rental:",i)}finally{m.value=!1}},U=()=>{t.value={device_id:null,start_date:"",end_date:"",customer_name:"",customer_phone:"",destination:"",xianyu_order_no:"",order_amount:void 0},y.value="",_.value="",h.value="",C.value="",x({message:"已重置表单",position:"top"})};return(i,e)=>{const V=Ne,B=qe,$=Re,W=I,me=at,fe=Ie,j=re,G=He;return L(),Ee("div",mt,[l(V,{title:"预约档期",fixed:""}),Q("div",ft,[l(me,{onSubmit:E},{default:S(()=>[l($,{inset:"",title:"设备信息"},{default:S(()=>[l(B,{modelValue:y.value,"onUpdate:modelValue":e[0]||(e[0]=s=>y.value=s),label:"选择设备",placeholder:"点击选择设备",readonly:"","right-icon":"arrow",required:"",onClick:e[1]||(e[1]=s=>p.value=!0)},null,8,["modelValue"]),t.value.device_id?(L(),X(B,{key:0,label:"设备型号",value:a.value?.model||"-",readonly:""},null,8,["value"])):Z("",!0)]),_:1}),l($,{inset:"",title:"租赁日期"},{default:S(()=>[l(B,{modelValue:_.value,"onUpdate:modelValue":e[2]||(e[2]=s=>_.value=s),label:"开始日期",placeholder:"选择开始日期",readonly:"","right-icon":"calendar-o",required:"",onClick:e[3]||(e[3]=s=>g.value=!0)},null,8,["modelValue"]),l(B,{modelValue:h.value,"onUpdate:modelValue":e[4]||(e[4]=s=>h.value=s),label:"结束日期",placeholder:"选择结束日期",readonly:"","right-icon":"calendar-o",required:"",onClick:e[5]||(e[5]=s=>f.value=!0)},null,8,["modelValue"]),t.value.start_date&&t.value.end_date?(L(),X(B,{key:0,label:"租赁天数",value:`${Y()} 天`,readonly:""},null,8,["value"])):Z("",!0)]),_:1}),l($,{inset:"",title:"客户信息"},{default:S(()=>[l(B,{modelValue:t.value.customer_name,"onUpdate:modelValue":e[6]||(e[6]=s=>t.value.customer_name=s),label:"客户名称",placeholder:"请输入客户名称",required:"",rules:[{required:!0,message:"请输入客户名称"}]},null,8,["modelValue"]),l(B,{modelValue:t.value.customer_phone,"onUpdate:modelValue":e[7]||(e[7]=s=>t.value.customer_phone=s),label:"联系电话",placeholder:"请输入联系电话",type:"tel",required:"",rules:[{required:!0,message:"请输入联系电话"},{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号"}]},null,8,["modelValue"]),l(B,{modelValue:t.value.destination,"onUpdate:modelValue":e[8]||(e[8]=s=>t.value.destination=s),label:"目的地",placeholder:"请输入目的地",required:"",rules:[{required:!0,message:"请输入目的地"}]},null,8,["modelValue"])]),_:1}),l($,{inset:"",title:"订单信息(可选)"},{default:S(()=>[l(B,{modelValue:t.value.xianyu_order_no,"onUpdate:modelValue":e[9]||(e[9]=s=>t.value.xianyu_order_no=s),label:"闲鱼订单号",placeholder:"请输入闲鱼订单号"},null,8,["modelValue"]),l(B,{modelValue:C.value,"onUpdate:modelValue":e[10]||(e[10]=s=>C.value=s),label:"订单金额",placeholder:"请输入订单金额",type:"number"},null,8,["modelValue"])]),_:1}),Q("div",vt,[l(W,{round:"",block:"",type:"primary","native-type":"submit",loading:m.value},{default:S(()=>[...e[19]||(e[19]=[ee(" 创建租赁 ",-1)])]),_:1},8,["loading"]),l(W,{round:"",block:"",plain:"",type:"default",onClick:U},{default:S(()=>[...e[20]||(e[20]=[ee(" 重置 ",-1)])]),_:1})])]),_:1})]),l(j,{show:p.value,"onUpdate:show":e[12]||(e[12]=s=>p.value=s),position:"bottom"},{default:S(()=>[l(fe,{columns:n.value,onConfirm:r,onCancel:e[11]||(e[11]=s=>p.value=!1)},null,8,["columns"])]),_:1},8,["show"]),l(j,{show:g.value,"onUpdate:show":e[15]||(e[15]=s=>g.value=s),position:"bottom"},{default:S(()=>[l(G,{modelValue:k.value,"onUpdate:modelValue":e[13]||(e[13]=s=>k.value=s),title:"选择开始日期","min-date":N(T),"max-date":N(M),onConfirm:d,onCancel:e[14]||(e[14]=s=>g.value=!1)},null,8,["modelValue","min-date","max-date"])]),_:1},8,["show"]),l(j,{show:f.value,"onUpdate:show":e[18]||(e[18]=s=>f.value=s),position:"bottom"},{default:S(()=>[l(G,{modelValue:P.value,"onUpdate:modelValue":e[16]||(e[16]=s=>P.value=s),title:"选择结束日期","min-date":N(T),"max-date":N(M),onConfirm:c,onCancel:e[17]||(e[17]=s=>f.value=!1)},null,8,["modelValue","min-date","max-date"])]),_:1},8,["show"])])}}}),Bt=Le(pt,[["__scopeId","data-v-84cdf7ca"]]);export{Bt as default};

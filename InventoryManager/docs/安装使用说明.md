# 库存管理系统 - 安装使用说明

## 系统概述

这是一个Flask开发的库存管理系统，具备设备租赁、甘特图可视化、以及自动生成租赁合同等功能。

## 核心功能

1. **设备库存管理** - 设备的增删改查、状态跟踪
2. **租赁管理** - 租赁记录的创建、查看、修改
3. **甘特图可视化** - 可视化展示设备租赁时间线
4. **智能合同生成** - 严格按照Word模板格式生成租赁合同
5. **身份证OCR识别** - 自动识别身份证信息并填入合同

## 环境要求

- Python 3.9+
- MySQL 数据库

## 安装步骤

### 1. 克隆项目
```bash
cd /Users/jimmypan/git_repo/XianyuAutoAgent/InventoryManager
```

### 2. 安装基础依赖
```bash
pip install -r requirements.txt
```

### 3. 安装OCR依赖（可选）
如果需要身份证OCR识别功能：
```bash
# 阿里云OCR SDK
pip install alibabacloud-ocr-api20210707
```

### 4. 配置阿里云OCR服务（可选）
需要配置阿里云访问密钥：
```bash
export ALIYUN_ACCESS_KEY_ID=your_access_key_id
export ALIYUN_ACCESS_KEY_SECRET=your_access_key_secret
```

或在`.env`文件中配置：
```
ALIYUN_ACCESS_KEY_ID=your_access_key_id
ALIYUN_ACCESS_KEY_SECRET=your_access_key_secret
```

### 5. 配置数据库
编辑 `.env` 文件，配置数据库连接：
```
DB_HOST=localhost
DB_PORT=3306
DB_USER=your_username
DB_PASSWORD=your_password
DB_NAME=inventory_db
```

### 6. 初始化数据库
```bash
python -c "from app import create_app, db; app = create_app(); app.app_context().push(); db.create_all()"
```

## 运行系统

### 开发模式
```bash
python app.py
```

### 生产模式
```bash
gunicorn -w 4 -b 0.0.0.0:5001 app:app
```

访问：http://localhost:5001

## 功能使用指南

### 1. 租赁合同功能

#### 步骤1：访问甘特图
- 登录系统后进入设备管理页面
- 点击"甘特图"查看设备租赁时间线

#### 步骤2：生成合同
- 在甘特图中找到要生成合同的租赁时段
- 悬停在租赁条上，弹出租赁信息框
- 点击"租赁合同"按钮，新窗口打开合同页面

#### 步骤3：上传身份证（可选）
- 如果安装了EasyOCR，可以上传身份证照片
- 系统自动识别姓名和身份证号
- 点击"填入合同"将识别结果填入合同模板

#### 步骤4：打印合同
- 检查合同信息是否正确
- 点击"打印合同"按钮打印或保存为PDF

### 2. 合同格式说明

合同严格按照 `docs/设备租赁合同模板.docx` 的格式生成，包含：

- **合同标题**：设备租赁合同（设备名称）
- **甲乙双方信息**：甲方（出租方）、乙方（承租方）详细信息
- **租赁设备清单**：设备名称、序列号、价值等
- **租赁期限**：收货日、租赁起止日期、归还日、总天数
- **押金信息**：押金金额、支付方式、退还条件
- **合同条款**：权利义务、损坏赔偿、违约条款等

### 3. OCR识别功能

#### 支持的身份证格式
- 中华人民共和国居民身份证正面
- 照片需清晰、完整，光线充足  
- 支持JPG、PNG等常见图片格式

#### 识别逻辑
- **使用阿里云通用OCR**：支持打码和部分遮挡的身份证
- **智能文本提取**：从OCR结果中智能提取姓名和身份证号
- **多模式匹配**：支持多种身份证文本格式

#### 配置OCR服务
```bash
# 安装阿里云OCR SDK
pip install alibabacloud-ocr-api20210707 alibabacloud-tea-openapi

# 配置访问密钥
export ALIYUN_ACCESS_KEY_ID=your_access_key_id
export ALIYUN_ACCESS_KEY_SECRET=your_access_key_secret
```

#### 获取阿里云密钥
1. 登录阿里云控制台
2. 进入"文字识别"服务
3. 开通身份证识别功能
4. 创建Access Key

## 技术架构

### 后端技术栈
- **Flask** - Web框架
- **SQLAlchemy** - ORM数据库操作
- **阿里云OCR** - 通用文字识别服务
- **Pillow** - 图像处理
- **python-docx** - Word文档解析

### 前端技术栈
- **Bootstrap** - UI框架
- **JavaScript** - 前端逻辑
- **Chart.js/甘特图库** - 数据可视化

### 文件结构
```
InventoryManager/
├── app/                    # Flask应用
│   ├── models/            # 数据模型
│   ├── routes/            # 路由控制器
│   └── templates/         # HTML模板
├── static/                # 静态资源
│   ├── css/              # 样式文件
│   └── js/               # JavaScript文件
├── docs/                  # 文档和样例
├── ocr_functions.py       # OCR识别功能
├── requirements.txt       # Python依赖
└── app.py                # 应用入口

## 故障排除

### 1. OCR识别失败
- **错误**: "阿里云OCR SDK未安装"
- **解决**: 执行 `pip install alibabacloud-ocr-api20210707`
- **错误**: "阿里云OCR配置不完整"
- **解决**: 设置环境变量 `ALIYUN_ACCESS_KEY_ID` 和 `ALIYUN_ACCESS_KEY_SECRET`
- **说明**: 系统使用阿里云通用OCR，支持打码和部分遮挡的身份证

### 2. 数据库连接失败
- 检查 `.env` 文件中的数据库配置
- 确认MySQL服务已启动
- 验证用户权限

### 3. 端口占用
- **错误**: "Address already in use"
- **解决**: 更改端口或关闭占用进程
```bash
# 查看端口占用
lsof -i :5001

# 修改端口启动
python app.py --port 5002
```

### 4. 合同格式问题
- 合同严格按照Word模板格式生成
- 如需修改格式，请更新 `templates/rental_contract.html`
- 占位符格式：`{{ variable_name }}`

## 开发说明

### 添加新的OCR库
如果需要更换OCR库，修改 `ocr_functions.py` 中的 `_recognize_with_easyocr` 函数。

### 修改合同模板
1. 更新 `docs/设备租赁合同模板.docx`
2. 修改 `templates/rental_contract.html`
3. 确保占位符变量名一致

### 自定义样式
修改 `static/css/` 中的CSS文件来自定义界面样式。

## 联系支持

如果遇到问题，请：
1. 查看日志文件了解详细错误信息
2. 检查本文档的故障排除部分
3. 确认所有依赖已正确安装

---

**版本**: 1.0.0  
**更新日期**: 2025-08-22  
**兼容性**: Python 3.9+, Flask 2.3+

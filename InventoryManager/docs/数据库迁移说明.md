# 数据库迁移说明

## 迁移概述

本次迁移主要包含以下变更：
1. 删除 users 表
2. 修改 devices 表主键类型（从 UUID 改为自增整数）
3. 简化 devices 表结构
4. 简化 rentals 表结构
5. 简化 audit_logs 表结构

## 迁移前准备

### 1. 数据备份
```bash
# 如果使用 MySQL
mysqldump -u username -p database_name > backup_before_migration.sql

# 如果使用 SQLite
cp inventory_management.db inventory_management_backup.db
```

### 2. 停止应用
确保在迁移期间停止所有相关的应用程序，避免数据不一致。

## 执行迁移

### 方法1：使用 Alembic（推荐）

```bash
# 安装 Alembic
pip install alembic

# 初始化 Alembic（如果还没有初始化）
alembic init migrations

# 执行迁移
alembic upgrade head
```

### 方法2：手动执行 SQL

如果无法使用 Alembic，可以手动执行以下 SQL 语句：

#### 1. 删除 users 表
```sql
DROP TABLE IF EXISTS users;
```

#### 2. 修改 devices 表主键
```sql
-- 删除外键约束
ALTER TABLE rentals DROP FOREIGN KEY fk_rentals_device_id;
ALTER TABLE audit_logs DROP FOREIGN KEY fk_audit_logs_device_id;

-- 修改主键类型
ALTER TABLE devices MODIFY COLUMN id INT AUTO_INCREMENT;

-- 重新创建外键约束
ALTER TABLE rentals ADD CONSTRAINT fk_rentals_device_id 
    FOREIGN KEY (device_id) REFERENCES devices(id);
ALTER TABLE audit_logs ADD CONSTRAINT fk_audit_logs_device_id 
    FOREIGN KEY (device_id) REFERENCES devices(id);
```

#### 3. 删除不需要的字段
```sql
-- 删除 devices 表字段
ALTER TABLE devices DROP COLUMN type;
ALTER TABLE devices DROP COLUMN model;
ALTER TABLE devices DROP COLUMN brand;
ALTER TABLE devices DROP COLUMN condition;
ALTER TABLE devices DROP COLUMN purchase_date;
ALTER TABLE devices DROP COLUMN purchase_price;
ALTER TABLE devices DROP COLUMN current_value;
ALTER TABLE devices DROP COLUMN daily_rate;
ALTER TABLE devices DROP COLUMN weekly_rate;
ALTER TABLE devices DROP COLUMN monthly_rate;
ALTER TABLE devices DROP COLUMN description;
ALTER TABLE devices DROP COLUMN specifications;
ALTER TABLE devices DROP COLUMN notes;

-- 删除 rentals 表字段
ALTER TABLE rentals DROP COLUMN customer_email;
ALTER TABLE rentals DROP COLUMN customer_company;
ALTER TABLE rentals DROP COLUMN purpose;
ALTER TABLE rentals DROP COLUMN daily_rate;
ALTER TABLE rentals DROP COLUMN total_cost;
ALTER TABLE rentals DROP COLUMN deposit;
ALTER TABLE rentals DROP COLUMN created_by;
ALTER TABLE rentals DROP COLUMN approved_by;
ALTER TABLE rentals DROP COLUMN approved_at;
ALTER TABLE rentals DROP COLUMN notes;
ALTER TABLE rentals DROP COLUMN return_notes;

-- 删除 audit_logs 表字段
ALTER TABLE audit_logs DROP COLUMN user_id;
```

## 迁移后验证

### 1. 检查表结构
```sql
-- 检查 devices 表
DESCRIBE devices;

-- 检查 rentals 表
DESCRIBE rentals;

-- 检查 audit_logs 表
DESCRIBE audit_logs;
```

### 2. 检查数据完整性
```sql
-- 检查设备数据
SELECT COUNT(*) FROM devices;

-- 检查租赁记录
SELECT COUNT(*) FROM rentals;

-- 检查外键约束
SELECT * FROM rentals r 
JOIN devices d ON r.device_id = d.id 
LIMIT 5;
```

### 3. 测试应用功能
- 启动应用程序
- 测试设备管理功能
- 测试租赁管理功能
- 检查日志记录功能

## 回滚方案

如果迁移出现问题，可以使用以下方法回滚：

### 使用 Alembic 回滚
```bash
alembic downgrade -1
```

### 手动回滚
1. 恢复备份数据
2. 重新创建删除的表和字段
3. 恢复原始的主键类型

## 注意事项

### 1. 主键类型变更
- devices 表的主键从 UUID 改为自增整数
- 这会影响所有引用该表的外键关系
- 确保在修改主键类型前删除相关的外键约束

### 2. 数据丢失风险
- 删除字段会永久丢失相关数据
- 建议在迁移前确认这些字段确实不再需要

### 3. 应用兼容性
- 确保应用程序代码已更新为使用新的模型结构
- 检查所有相关的 API 接口和前端页面

### 4. 性能影响
- 自增整数主键通常比 UUID 有更好的性能
- 但可能需要重新生成一些索引

## 故障排除

### 常见问题

#### 1. 外键约束错误
```
Error: Cannot add foreign key constraint
```
**解决方案**：确保在修改主键类型前删除所有相关的外键约束

#### 2. 数据类型不匹配
```
Error: Data type mismatch
```
**解决方案**：检查字段类型是否与预期一致

#### 3. 表不存在
```
Error: Table doesn't exist
```
**解决方案**：确认表名拼写正确，检查数据库连接

### 获取帮助
如果遇到问题，可以：
1. 检查数据库日志
2. 查看应用程序错误日志
3. 联系数据库管理员
4. 参考数据库官方文档

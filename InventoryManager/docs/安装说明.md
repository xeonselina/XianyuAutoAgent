# 库存管理系统安装说明

## 系统要求

- Python 3.8 或更高版本
- pip 包管理器
- MySQL 5.7+ 或 SQLite 3
- 操作系统：Windows、macOS、Linux

## 安装步骤

### 1. 克隆项目

```bash
git clone <repository-url>
cd InventoryManager
```

### 2. 创建虚拟环境（推荐）

```bash
# 使用 venv（Python 3.3+）
python3 -m venv venv

# 激活虚拟环境
# macOS/Linux:
source venv/bin/activate
# Windows:
# venv\Scripts\activate
```

### 3. 安装依赖

#### 方法1：使用开发依赖文件（推荐）

```bash
# 安装开发环境依赖（不包含有问题的gevent包）
pip install -r requirements-dev.txt
```

#### 方法2：使用完整依赖文件

```bash
# 如果遇到gevent编译问题，可以跳过有问题的包
pip install -r requirements.txt --no-deps
pip install Flask==2.3.3 Flask-SQLAlchemy==3.0.5 Flask-Migrate==4.0.5 Flask-CORS==4.0.0
pip install PyMySQL==1.1.0 cryptography==41.0.7
pip install pandas==2.1.1 openpyxl==3.1.2
pip install python-dotenv==1.0.0 Werkzeug==2.3.7 click==8.1.7
pip install loguru==0.7.2
```

#### 方法3：逐个安装核心依赖

```bash
# 核心Flask框架
pip install Flask==2.3.3
pip install Flask-SQLAlchemy==3.0.5
pip install Flask-Migrate==4.0.5
pip install Flask-CORS==4.0.0

# 数据库驱动
pip install PyMySQL==1.1.0
pip install cryptography==41.0.7

# 数据处理
pip install pandas==2.1.1
pip install openpyxl==3.1.2

# 工具库
pip install python-dotenv==1.0.0
pip install Werkzeug==2.3.7
pip install click==8.1.7

# 日志
pip install loguru==0.7.2
```

### 4. 配置环境变量

```bash
# 复制对应的环境配置文件
cp env.local .env          # 本地开发环境
# 或者
cp env.production .env     # 生产环境
# 或者
cp env.docker .env         # Docker环境

# 编辑配置文件，设置数据库连接信息
nano .env
```

### 5. 配置数据库

#### 使用MySQL（推荐生产环境）

```bash
# 创建数据库
mysql -u root -p
CREATE DATABASE inventory_management;
CREATE USER 'inventory_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON inventory_management.* TO 'inventory_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

#### 使用SQLite（开发环境，简单）

```bash
# 在.env文件中设置
DATABASE_URL=sqlite:///inventory_management.db
```

### 6. 初始化数据库

```bash
# 设置Flask环境
export FLASK_APP=app.py
export FLASK_ENV=development

# 初始化数据库
flask init-db
# 或者
python -c "from app import create_app, db; app = create_app(); app.app_context().push(); db.create_all()"
```

### 7. 启动应用

```bash
# 开发模式
flask run
# 或者
python app.py

# 生产模式
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

## 常见问题解决

### 1. gevent 编译失败

**问题描述**：在 macOS 上安装 gevent 时出现编译错误

**解决方案**：
```bash
# 方法1：跳过有问题的包
pip install -r requirements.txt --no-deps
pip install Flask Flask-SQLAlchemy Flask-Migrate Flask-CORS PyMySQL

# 方法2：使用替代方案
pip install eventlet==0.33.3  # 替代 gevent

# 方法3：使用预编译的wheel包
pip install --only-binary=all gevent
```

### 2. cryptography 安装失败

**问题描述**：cryptography 包编译失败

**解决方案**：
```bash
# 安装编译依赖
# macOS:
brew install openssl pkg-config

# Ubuntu/Debian:
sudo apt-get install build-essential libssl-dev libffi-dev python3-dev

# 然后重新安装
pip install cryptography
```

### 3. PyMySQL 连接问题

**问题描述**：无法连接到 MySQL 数据库

**解决方案**：
```bash
# 检查MySQL服务状态
sudo systemctl status mysql  # Linux
brew services list | grep mysql  # macOS

# 检查防火墙设置
sudo ufw status  # Ubuntu
sudo firewall-cmd --list-all  # CentOS

# 检查MySQL用户权限
mysql -u root -p
SHOW GRANTS FOR 'inventory_user'@'localhost';
```

### 4. 权限问题

**问题描述**：pip 安装时出现权限错误

**解决方案**：
```bash
# 使用用户安装
pip install --user -r requirements.txt

# 或者使用虚拟环境（推荐）
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

## 开发环境配置

### 1. 启用调试模式

```bash
export FLASK_ENV=development
export FLASK_DEBUG=1
```

### 2. 配置日志

```bash
export LOG_LEVEL=DEBUG
export LOG_FILE=logs/inventory_service.log
```

### 3. 数据库连接池配置

```bash
export DB_POOL_SIZE=5
export DB_POOL_RECYCLE=3600
```

## 生产环境部署

### 1. 使用 Gunicorn

```bash
# 安装生产服务器
pip install gunicorn

# 启动服务
gunicorn -w 4 -b 0.0.0.0:5000 --timeout 120 app:app
```

### 2. 使用 Docker

```bash
# 构建镜像
docker build -t inventory-manager .

# 运行容器
docker run -p 5000:5000 --env-file .env inventory-manager
```

### 3. 使用 Docker Compose

```bash
# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f app
```

## 验证安装

### 1. 检查依赖

```bash
pip list | grep -E "(Flask|SQLAlchemy|PyMySQL)"
```

### 2. 测试数据库连接

```python
python -c "
from app import create_app, db
app = create_app()
with app.app_context():
    try:
        db.engine.execute('SELECT 1')
        print('数据库连接成功')
    except Exception as e:
        print(f'数据库连接失败: {e}')
"
```

### 3. 启动测试

```bash
# 启动应用
python app.py

# 在另一个终端测试
curl http://localhost:5000/health
```

## 下一步

安装完成后，请参考以下文档：
- [环境变量配置说明](环境变量配置说明.md)
- [数据库迁移说明](数据库迁移说明.md)
- [模型变更说明](模型变更说明.md)
- [API使用说明](API使用说明.md)

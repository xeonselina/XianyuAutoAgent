# Feature Specification: 甘特图日期可见性增强

**Feature Branch**: `002-gantt-date-labels`
**Created**: 2026-01-01
**Status**: Draft
**Input**: User description: "现在的甘特图是这个样子的,看不出来几号有几号没有"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看设备每日可用性 (Priority: P1) 🎯 MVP

运营人员在查看设备档期时,需要快速识别哪些具体日期已被预约占用,哪些日期是空闲可预约的,以便为客户提供准确的档期信息。

**Why this priority**: 这是核心功能,直接影响运营效率。当前甘特图只显示彩色条块但无日期标签,运营人员无法快速判断具体日期的可用性,必须点击或手动计算,严重影响工作效率。

**Independent Test**: 在设备档期页面加载后,用户应能够一眼看出任意设备在本周内哪几天有预约(如1号、3号、5号已占用),哪几天空闲(如2号、4号、6号、7号可预约),无需额外交互。

**Acceptance Scenarios**:

1. **Given** 用户打开设备档期页面查看本周档期, **When** 页面加载完成, **Then** 甘特图时间轴显示清晰的日期标签(如"1月1日 周一"、"1月2日 周二"等),用户可直接识别具体日期
2. **Given** 某设备有多个租赁档期, **When** 用户查看该设备的甘特图行, **Then** 每个租赁条块上或旁边显示具体的起止日期(如"1/1-1/3"、"1/5-1/7"),用户无需点击即可知道占用的具体日期
3. **Given** 用户在查看档期, **When** 遇到连续多天的预约, **Then** 长条块应清晰标注天数跨度(如"1/1-1/5 (5天)"),避免用户手动计算
4. **Given** 用户需要查找空闲日期, **When** 查看甘特图, **Then** 空闲日期区域应有明显的视觉区分(如浅灰色背景或网格线),使空档期一目了然

---

### User Story 2 - 快速定位特定日期 (Priority: P2)

运营人员接到客户询问"1月15日这个设备有空吗?"时,需要快速在甘特图中定位到1月15日,检查该日是否有预约。

**Why this priority**: 提升查询效率,减少客户等待时间。虽然不是核心功能,但对日常运营体验有显著改善。

**Independent Test**: 用户在设备档期页面,通过点击时间轴上的日期标签或使用日期定位功能,能够快速滚动/跳转到指定日期(如1月15日),并高亮显示该日期列,确认设备可用性。

**Acceptance Scenarios**:

1. **Given** 用户需要查询1月15日的档期, **When** 用户点击或选择"1月15日", **Then** 甘特图自动滚动到该日期,并高亮显示该日期列,用户可立即看到所有设备在该日的状态
2. **Given** 当前显示的是本周档期(如1月1-7日), **When** 用户需要查看下个月的档期(如2月10日), **Then** 系统提供快速跳转功能(如日期选择器),避免用户手动滚动多周
3. **Given** 用户正在查看某个特定日期, **When** 该日期被高亮显示, **Then** 高亮状态应持续保持,直到用户主动切换到其他日期或关闭高亮

---

### User Story 3 - 查看每日设备统计信息 (Priority: P2) 🎯 高优先级

运营人员在移动端查看设备档期时,需要快速了解每一天有多少设备需要寄出(发货),有多少设备处于空闲状态,以便合理安排物流和设备调度。

**Why this priority**: 这是运营管理的关键数据,直接影响物流安排和资源调度。尤其在移动端,运营人员需要快速获取这些统计信息以做出决策。

**Independent Test**: 在移动端设备档期页面,每个日期列应显示当日的关键统计数据:"X台寄出 / Y台空闲",用户可立即了解当日设备状态总览。

**Acceptance Scenarios**:

1. **Given** 用户在移动端打开设备档期页面, **When** 页面加载完成, **Then** 每个日期下方或上方显示当日统计信息(如"3台寄出 / 2台空闲"),用户可快速识别繁忙日期
2. **Given** 某日有3台设备的shipoutdate是该日(需要发货), **When** 用户查看该日期, **Then** 显示"3台寄出",准确反映当日发货工作量
3. **Given** 某日总共有5台设备,其中3台在租用期内(shipoutdate到shipindate范围内), **When** 用户查看该日期, **Then** 显示"2台空闲"(5-3=2),准确反映可用设备数量
4. **Given** 用户点击某日的统计信息, **When** 展开详情, **Then** 显示当日寄出设备列表和空闲设备列表,方便查看具体设备

---

### User Story 4 - 修复空闲设备统计逻辑 (Priority: P1) 🎯 MVP (缺陷修复)

当前系统统计空闲设备时,只计算starttime到endtime范围内的占用,但实际应该计算shipoutdate(包含)到shipindate(包含)范围内的占用,否则会导致统计不准确,影响运营决策。

**Why this priority**: 这是一个缺陷修复,导致数据不准确,可能造成重复预约或物流混乱。必须优先修复。

**Independent Test**: 创建一个租赁档期(如starttime=1月5日,endtime=1月7日,shipoutdate=1月3日,shipindate=1月9日),验证系统在1月3日、1月4日、1月8日、1月9日都将该设备标记为"占用",在统计空闲设备时不计入这些日期。

**Acceptance Scenarios**:

1. **Given** 设备A有租赁档期(starttime=1/5,endtime=1/7,shipoutdate=1/3,shipindate=1/9), **When** 系统统计1月3日的空闲设备, **Then** 设备A被标记为"占用"(因为shipoutdate=1/3),不计入空闲设备
2. **Given** 设备B有租赁档期(starttime=1/5,endtime=1/7,shipoutdate=1/3,shipindate=1/9), **When** 系统统计1月9日的空闲设备, **Then** 设备B被标记为"占用"(因为shipindate=1/9),不计入空闲设备
3. **Given** 设备C有租赁档期(starttime=1/5,endtime=1/7,shipoutdate=1/3,shipindate=1/9), **When** 系统统计1月4日/1月6日/1月8日的空闲设备, **Then** 设备C都被标记为"占用"(在shipoutdate到shipindate范围内),不计入空闲设备
4. **Given** 设备D有租赁档期(starttime=1/5,endtime=1/7,shipoutdate=1/3,shipindate=1/9), **When** 系统统计1月1日或1月10日的空闲设备, **Then** 设备D被标记为"空闲"(不在shipoutdate到shipindate范围内),计入空闲设备

---

### User Story 5 - 区分工作日和周末 (Priority: P3)

运营人员在安排设备档期时,需要快速识别哪些日期是工作日,哪些是周末,因为周末的租赁需求和定价策略通常不同。

**Why this priority**: 增强功能,帮助运营人员更好地规划档期。虽然不是必需功能,但对业务规划有帮助。

**Independent Test**: 在设备档期页面,周末日期(周六、周日)应有明显的视觉区分(如不同背景色或标记),用户可快速识别本周哪些天是周末。

**Acceptance Scenarios**:

1. **Given** 用户查看一周的设备档期, **When** 页面加载完成, **Then** 周六和周日的日期列应有视觉区分(如浅蓝色背景或周末标签),与工作日明显不同

---

### Edge Cases

- **跨月份显示**: 当甘特图横跨多个月份时(如12月28日-1月5日),月份切换处应有明确的视觉分隔或月份标签,避免用户混淆日期
- **移动端显示**: 在小屏幕设备上,日期标签可能因空间不足而重叠或显示不全,需要适配方案(如缩写、旋转、分层显示)
- **长期档期**: 当某个租赁跨度超过30天时,日期标签可能过长(如"1/1-2/15"),需要优化显示方式(如仅显示起止日期,中间用"..."省略)
- **时区处理**: 如果系统支持多时区用户,日期显示应基于用户所在时区,避免日期错乱
- **实时更新**: 当其他用户新增或修改档期时,当前用户的甘特图应实时或定期刷新,确保日期可用性信息准确
- **空数据状态**: 当某设备完全没有任何档期预约时,甘特图应显示"暂无档期"或空白网格,避免用户误以为数据加载失败

## Requirements *(mandatory)*

### Functional Requirements

#### 日期标签与可见性

- **FR-001**: 系统必须在甘特图的时间轴上显示清晰的日期标签,包括日期(如"1月1日")和星期(如"周一")
- **FR-002**: 系统必须在每个租赁条块上或旁边标注具体的起止日期,格式为"MM/DD-MM/DD"(如"1/1-1/3")
- **FR-003**: 系统必须为跨度超过3天的租赁条块显示天数统计(如"(5天)"),帮助用户快速评估档期长度
- **FR-004**: 系统必须为空闲日期提供视觉区分(如浅灰色背景或网格线),使未被预约的日期一目了然
- **FR-005**: 系统必须在时间轴上区分周末(周六、周日)和工作日,使用不同的背景色或标记

#### 日期导航与交互

- **FR-006**: 系统必须支持日期跳转功能,用户可通过日期选择器或点击日期快速定位到指定日期
- **FR-007**: 系统必须高亮用户选中的日期列,持续显示直到用户切换到其他日期
- **FR-008**: 系统必须在月份切换处显示明确的视觉分隔线和月份标签(如"2026年1月 | 2026年2月")
- **FR-009**: 系统必须在移动端适配日期标签显示,确保小屏幕上日期信息清晰可读(可采用缩写、旋转或分层显示)
- **FR-010**: 系统必须在甘特图加载时默认显示当前日期所在周,并高亮"今天"日期
- **FR-011**: 系统必须在租赁条块悬停时显示详细的档期信息(租赁者、起止日期、天数、备注等)
- **FR-012**: 系统必须为超长租赁条块(跨度>30天)优化日期显示,避免标签过长影响可读性

#### 每日设备统计 (新增)

- **FR-013**: 系统必须在移动端每个日期下方或上方显示当日统计信息,格式为"X台寄出 / Y台空闲"
- **FR-014**: 系统必须统计每日需要寄出的设备数量,定义为当日shipoutdate等于该日期的设备总数
- **FR-015**: 系统必须统计每日空闲设备数量,定义为总设备数减去当日被占用的设备数(被占用=shipoutdate ≤ 当日 ≤ shipindate)
- **FR-016**: 系统必须支持用户点击统计信息展开详情,显示当日寄出设备列表和空闲设备列表
- **FR-017**: 系统必须在桌面端也显示每日统计信息(可选:以更紧凑的方式显示,如图标+数字)

#### 空闲设备统计逻辑修复 (缺陷修复)

- **FR-018**: 系统必须将设备占用期间定义为shipoutdate(包含)到shipindate(包含)的完整日期范围,而非仅starttime到endtime
- **FR-019**: 系统必须在统计某日空闲设备时,排除所有满足条件"shipoutdate ≤ 该日 ≤ shipindate"的设备
- **FR-020**: 系统必须确保甘特图上的租赁条块覆盖范围与空闲统计逻辑一致(都基于shipoutdate到shipindate)
- **FR-021**: 系统必须在API接口中使用正确的日期范围查询条件(shipoutdate/shipindate而非starttime/endtime)用于空闲统计

### Key Entities

- **日期标签 (Date Label)**: 时间轴上的日期显示元素,包含日期(MM/DD)、星期(周X)、月份(可选),可能包含特殊标记(今天、周末、节假日)
- **租赁条块 (Rental Bar)**: 甘特图中表示设备被租用时间段的彩色条块,包含起止日期标签、天数统计、租赁者信息,覆盖范围为shipoutdate到shipindate
- **空闲区域 (Available Slot)**: 甘特图中未被租赁占用的时间段,需要视觉区分以标识可预约状态
- **时间轴 (Timeline)**: 甘特图顶部的日期序列,包含日期标签、月份分隔、周末标记等元素
- **日期高亮 (Date Highlight)**: 用户选中或当前日期的视觉强调状态,用于快速定位和识别
- **每日统计 (Daily Statistics)**: 每个日期的设备状态汇总信息,包含两个关键指标:
  - 寄出数量:当日shipoutdate的设备总数(需要发货)
  - 空闲数量:当日未被占用的设备总数(总设备数 - 占用设备数)
- **设备占用期 (Device Occupancy Period)**: 设备被租用的完整时间范围,从shipoutdate(包含)到shipindate(包含),用于判断设备在某日是否可用

## Success Criteria *(mandatory)*

### Measurable Outcomes

#### 查询效率提升

- **SC-001**: 运营人员查询"某设备某日是否可用"的平均响应时间从目前的30秒减少到5秒以内
- **SC-002**: 95%的档期查询无需点击或交互,仅通过视觉扫描即可完成(无需点击条块查看日期)
- **SC-003**: 用户在3秒内能识别任意设备在当前显示周内的空闲日期数量
- **SC-007**: 跨月份查询(如从1月跳转到3月)的操作时间少于3秒

#### 用户体验改善

- **SC-004**: 移动端用户能够清晰阅读所有日期标签,误读率低于5%
- **SC-006**: 90%的用户在首次使用新甘特图后,能够不依赖说明文档独立完成档期查询任务
- **SC-008**: 甘特图页面加载完成后,所有日期标签应在1秒内渲染完成,不影响页面性能

#### 数据准确性提升 (新增)

- **SC-005**: 减少因"日期不清晰"导致的档期重复预约错误,错误率从当前的15%降低到2%以内
- **SC-009**: 修复空闲设备统计逻辑后,空闲设备统计准确率达到100%(当前因使用错误的日期范围导致准确率约70%)
- **SC-010**: 消除因统计逻辑错误导致的重复预约冲突,冲突率从当前的10%降低到0%

#### 运营决策支持 (新增)

- **SC-011**: 运营人员查询"某日需要发货多少台设备"的响应时间从目前的60秒(需手动统计)减少到即时显示(0秒)
- **SC-012**: 运营人员查询"某日有多少空闲设备"的响应时间从目前的45秒(需手动统计)减少到即时显示(0秒)
- **SC-013**: 物流安排准备时间减少50%,因为每日发货数量一目了然,无需逐条查看档期

## Assumptions *(optional)*

### 显示与格式

- 假设用户主要使用的日期格式为"月/日"(MM/DD),符合中国用户习惯
- 假设一周从周一开始,周日结束(可能需要根据用户偏好调整)
- 假设甘特图默认显示范围为"当前周±2周"(共5周),用户可自行调整
- 假设日期标签的字体大小和颜色遵循现有设计系统规范
- 假设移动端屏幕宽度最小为320px(iPhone SE),需在此尺寸上保证可读性
- 假设系统时区为中国标准时间(UTC+8),如需支持多时区则需额外开发

### 数据模型与业务逻辑

- 假设租赁记录包含以下日期字段:
  - **starttime**: 租赁开始日期(客户实际使用起始日)
  - **endtime**: 租赁结束日期(客户实际使用结束日)
  - **shipoutdate**: 发货日期(设备寄出日期,早于或等于starttime)
  - **shipindate**: 收货日期(设备收回日期,晚于或等于endtime)
- 假设设备占用期 = shipoutdate到shipindate(包含两端),这是设备不可用的完整时间段
- 假设设备在shipoutdate当天需要寄出,因此该日开始就算占用
- 假设设备在shipindate当天收回,因此该日仍算占用(设备未入库前不可再租)
- 假设总设备数量为系统中所有"在线"状态的设备总数,不包含已下架或维修中的设备
- 假设每日统计数据实时计算,不缓存(或缓存时间很短,如5分钟),确保数据准确性

## Dependencies *(optional)*

- 前端日期格式化库(如dayjs或date-fns)用于统一日期显示格式
- 现有甘特图组件库的API支持,需确认是否支持自定义日期标签渲染
- 设备租赁数据的准确性和实时性,确保甘特图显示的档期信息正确

## Out of Scope *(optional)*

- **日历视图切换**: 不包含从甘特图切换到日历视图的功能(如月视图、日视图)
- **批量档期编辑**: 不包含直接在甘特图上拖拽调整档期的功能(仍需通过表单编辑)
- **多设备对比**: 不包含同时对比多个设备档期的并排视图
- **导出甘特图**: 不包含将甘特图导出为图片或PDF的功能
- **国际化**: 暂不支持多语言日期格式(如英文月份名称),仅支持中文
- **自定义配色**: 暂不支持用户自定义甘特图配色方案(周末颜色、空闲区域颜色等)

# Feature Specification: 设备验货系统

**Feature Branch**: `002-device-inspection`  
**Created**: 2026-01-04  
**Status**: Draft  
**Input**: User description: "增加一个验货功能.用户故事大概是: 1. 在 ipad 上打开档期软件,点开验货页面 2. 验货页面是一个表单,先输入正在验货的设备名(纯数字,弹出数字键盘) 3. 得到设备名称后,拉取到这个设备最近的一个 rental(今天之前) 4. 显示这个 rental 的客户名称,电话,设备型号 5. 在基本信息下方,出现一个 checklist,checklist 包括: - 手机,镜头无严重磕碰 - 摄像头各焦段无白色十字 - 镜头镜片清晰,无雾无破裂 - 镜头拆装顺滑 - 充电头和充电线 if 有带手柄: - 手柄 endif if 带镜头支架: - 镜头支架 endif if 个性化附件: -  endif if 代传照片: - 代传照片 endif checklist 是一个个复选框任意一个没勾选,验机就算验机异常.全部复选框都勾上才算验机正常 6. 在编辑 rental 的时候增加一个代传照片的复选框. 7. 验机有一个验机记录列表,默认按照验机记录顺序倒叙排列.可以筛选设备名称,筛选验机状态 8. 验机记录打开后可以编辑每一个验机记录."

## 概述

为设备租赁管理系统添加验货功能，使工作人员能够在 iPad 上快速检查归还设备的状态。系统通过设备编号自动关联最近的租赁记录，使用标准化检查清单确保验货的一致性和完整性，并记录每次验货结果以便追溯和分析。

## User Scenarios & Testing

### User Story 1 - 快速验货流程 (Priority: P1)

工作人员收到归还的设备后，需要快速完成验货并记录设备状态。他们在 iPad 上打开验货页面，输入设备编号（例如：2001），系统自动显示该设备最近的租赁信息和对应的检查项目清单，工作人员逐项检查并勾选，完成后提交验货记录。

**为什么是 P1 优先级**: 这是核心功能，是整个验货系统的基础。没有这个功能，就无法进行设备验货。这个流程必须快速、准确，因为它直接影响设备周转效率和客户体验。

**独立测试**: 可以通过输入一个有效的设备编号，完整执行一次验货流程（从查询到提交），验证系统是否能正确显示租赁信息、检查项目，并成功保存验货结果。这个测试不依赖于其他功能，可以独立验证核心验货能力。

**Acceptance Scenarios**:

1. **Given** 设备 2001 在今天之前有一条租赁记录（客户：张三，电话：13800138000，设备型号：iPhone 14 Pro），**When** 工作人员在验货页面输入设备编号 "2001"，**Then** 系统显示该租赁的客户名称、电话、设备型号，以及包含所有基础检查项的清单

2. **Given** 显示了设备 2001 的验货清单，检查项包括：手机镜头无严重磕碰、摄像头各焦段无白色十字、镜头镜片清晰无雾无破裂、镜头拆装顺滑、充电头和充电线，**When** 工作人员逐项检查并全部勾选完成后点击提交，**Then** 系统保存验货记录，状态标记为"验机正常"

3. **Given** 显示了设备 2001 的验货清单，**When** 工作人员发现充电线有问题，仅勾选了部分检查项（未勾选"充电头和充电线"），然后点击提交，**Then** 系统保存验货记录，状态标记为"验机异常"

4. **Given** 验货页面已打开，**When** 工作人员输入的设备编号在今天之前没有任何租赁记录，**Then** 系统显示提示信息"未找到该设备的租赁记录"，不显示检查清单

---

### User Story 2 - 动态检查清单（附件相关） (Priority: P1)

不同租赁订单可能包含不同的附件（手柄、镜头支架、个性化附件等）。工作人员进行验货时，系统应该根据该订单实际包含的附件，动态生成相应的检查项，确保所有附件都被检查到。

**为什么是 P1 优先级**: 这是核心验货功能的关键部分。如果检查清单不能动态适配订单内容，会导致漏检或误检附件，影响验货准确性。这直接关系到设备和附件的完整性管理。

**独立测试**: 可以创建两条不同的租赁记录（一条包含手柄和镜头支架，一条不包含），分别进行验货，验证系统是否能根据订单内容正确生成不同的检查清单。这个测试可以独立验证动态清单生成的正确性。

**Acceptance Scenarios**:

1. **Given** 设备 2001 的最近租赁记录包含了手柄和镜头支架附件，**When** 工作人员输入设备编号 "2001" 进行验货，**Then** 检查清单中除了基础检查项外，还包括"手柄"和"镜头支架"两个检查项

2. **Given** 设备 2002 的最近租赁记录包含了个性化附件"手机支架-P01"，**When** 工作人员输入设备编号 "2002" 进行验货，**Then** 检查清单中包括"手机支架-P01"检查项

3. **Given** 设备 2003 的最近租赁记录标记了"代传照片"服务，**When** 工作人员输入设备编号 "2003" 进行验货，**Then** 检查清单中包括"代传照片"检查项

4. **Given** 设备 2004 的最近租赁记录不包含任何附件，也没有代传照片服务，**When** 工作人员输入设备编号 "2004" 进行验货，**Then** 检查清单只包含基础检查项（手机镜头无严重磕碰、摄像头各焦段无白色十字、镜头镜片清晰无雾无破裂、镜头拆装顺滑、充电头和充电线）

---

### User Story 3 - 租赁记录中添加"代传照片"标记 (Priority: P2)

在创建或编辑租赁订单时，工作人员需要能够标记该订单是否包含"代传照片"服务。这样验货时就能自动包含"代传照片"的检查项。

**为什么是 P2 优先级**: 这是支持动态检查清单的必要功能，但可以在核心验货功能之后实现。如果暂时没有这个功能，可以手工记录或使用备注字段，不会完全阻塞验货流程。

**独立测试**: 可以打开租赁订单编辑界面，添加"代传照片"复选框，勾选并保存，然后查询该订单验证字段是否正确保存。这个测试独立于验货功能，仅验证数据录入能力。

**Acceptance Scenarios**:

1. **Given** 工作人员正在创建一个新的租赁订单，**When** 在订单表单中看到"代传照片"复选框并勾选它，然后保存订单，**Then** 订单记录中保存了"代传照片"标记为 true

2. **Given** 工作人员正在编辑一个已存在的租赁订单，**When** 勾选"代传照片"复选框并保存，**Then** 订单记录中的"代传照片"标记更新为 true

3. **Given** 工作人员正在编辑一个已勾选"代传照片"的租赁订单，**When** 取消勾选"代传照片"复选框并保存，**Then** 订单记录中的"代传照片"标记更新为 false

---

### User Story 4 - 验货记录查询和管理 (Priority: P2)

工作人员需要查看历史验货记录，以便追溯设备状态、分析异常情况、或重新确认验货结果。他们可以打开验货记录列表页面，查看所有验货记录，并通过设备名称或验货状态进行筛选。

**为什么是 P2 优先级**: 这是重要的管理功能，但不阻塞核心验货流程。即使暂时没有查询功能，验货记录仍然会被保存，可以通过数据库或其他方式查询。但有了这个功能，可以大大提升工作效率和问题追溯能力。

**独立测试**: 可以创建多条验货记录（不同设备、不同状态），然后在验货记录列表页面进行查询和筛选，验证列表显示、排序、筛选功能是否正常工作。这个测试独立于验货创建功能，仅验证查询和展示能力。

**Acceptance Scenarios**:

1. **Given** 系统中已有 10 条验货记录，**When** 工作人员打开验货记录列表页面，**Then** 系统显示所有验货记录，按照验货时间倒序排列（最新的在最上面）

2. **Given** 验货记录列表页面已打开，**When** 工作人员在设备名称筛选框中输入 "2001"，**Then** 系统只显示设备编号为 2001 的验货记录

3. **Given** 验货记录列表页面已打开，**When** 工作人员在验货状态筛选器中选择"验机异常"，**Then** 系统只显示状态为"验机异常"的验货记录

4. **Given** 验货记录列表页面已打开，**When** 工作人员同时筛选设备名称 "2001" 和状态"验机正常"，**Then** 系统只显示设备编号为 2001 且状态为"验机正常"的验货记录

---

### User Story 5 - 编辑验货记录 (Priority: P3)

工作人员有时需要修正验货记录（例如：发现漏检、误操作等）。他们可以从验货记录列表中打开某条记录，重新勾选或取消勾选检查项，然后保存更新。

**为什么是 P3 优先级**: 这是补充功能，用于纠正错误。在正常情况下，验货应该一次完成。但有了这个功能，可以提高系统的容错性和灵活性。可以在核心功能稳定后再实现。

**独立测试**: 可以创建一条验货记录，然后打开该记录进行编辑，修改检查项的勾选状态并保存，验证记录是否正确更新。这个测试独立验证编辑功能，不依赖于其他流程。

**Acceptance Scenarios**:

1. **Given** 验货记录列表中有一条设备 2001 的"验机正常"记录，**When** 工作人员打开该记录，取消勾选"充电头和充电线"检查项，然后保存，**Then** 该记录的状态更新为"验机异常"，并记录修改时间

2. **Given** 验货记录列表中有一条设备 2002 的"验机异常"记录（"手柄"未勾选），**When** 工作人员打开该记录，勾选"手柄"检查项，使所有检查项都已勾选，然后保存，**Then** 该记录的状态更新为"验机正常"，并记录修改时间

3. **Given** 工作人员正在编辑一条验货记录，**When** 修改了部分检查项但点击"取消"按钮，**Then** 系统不保存任何修改，返回验货记录列表

---

### Edge Cases

- **设备编号输入错误**: 用户输入了不存在的设备编号，系统应提示"未找到该设备"，不显示检查清单
- **设备没有历史租赁记录**: 用户输入的设备编号是新设备或从未出租过，系统应提示"该设备没有租赁记录"
- **设备有租赁记录但都在今天或未来**: 系统查询"今天之前"的租赁记录时，如果只有今天或未来的记录，应提示"该设备没有可验货的租赁记录"
- **多条符合条件的租赁记录**: 如果设备在今天之前有多条租赁记录，系统应选择最近的一条（结束日期最晚的）
- **验货记录为空时的筛选**: 当验货记录列表为空时，应显示"暂无验货记录"的友好提示
- **网络中断时提交验货**: 如果在提交验货记录时网络中断，系统应提示保存失败"网络连接失败，请稍后重试"，用户需要在网络恢复后重新提交验货记录
- **并发编辑同一条验货记录**: 如果两个工作人员同时编辑同一条验货记录，后提交的修改会覆盖先提交的修改（乐观锁或最后写入胜出策略）

## Requirements

### Functional Requirements

#### 验货流程

- **FR-001**: 系统必须提供验货页面，支持在 iPad 等移动设备上访问和操作
- **FR-002**: 验货页面必须提供设备编号输入框，输入框应触发数字键盘（纯数字输入）
- **FR-003**: 系统必须根据设备编号查询该设备在今天之前的最近一条租赁记录（结束日期最晚的）
- **FR-004**: 查询到租赁记录后，系统必须显示：客户名称、客户电话、设备型号
- **FR-005**: 系统必须根据租赁记录内容，动态生成验货检查清单

#### 检查清单内容

- **FR-006**: 所有租赁记录的验货清单必须包含以下基础检查项（复选框形式）：
  - 手机,镜头无严重磕碰
  - 摄像头各焦段无白色十字
  - 镜头镜片清晰,无雾无破裂
  - 镜头拆装顺滑
  - 充电头和充电线

- **FR-007**: 如果租赁记录包含手柄附件（includes_handle = true），检查清单必须包含"手柄"检查项
- **FR-008**: 如果租赁记录包含镜头支架附件（includes_lens_mount = true），检查清单必须包含"镜头支架"检查项
- **FR-009**: 如果租赁记录包含个性化附件（accessories 列表非空），检查清单必须为每个附件添加一个检查项，检查项名称为附件名称
- **FR-010**: 如果租赁记录标记了"代传照片"服务，检查清单必须包含"代传照片"检查项

#### 验货状态判定

- **FR-011**: 系统必须根据检查清单的勾选情况自动判定验货状态：
  - 所有检查项都已勾选 → 验机正常
  - 任意一个检查项未勾选 → 验机异常

- **FR-012**: 系统必须保存验货记录，包含：设备编号、租赁记录ID、检查项勾选情况、验货状态、验货时间、验货人员（如果系统有用户登录）

#### 租赁记录编辑

- **FR-013**: 租赁记录的创建和编辑表单中，必须添加"代传照片"复选框
- **FR-014**: "代传照片"字段必须保存到租赁记录中，作为布尔值字段

#### 验货记录查询

- **FR-015**: 系统必须提供验货记录列表页面，显示所有验货记录
- **FR-016**: 验货记录列表必须默认按照验货时间倒序排列（最新的在最上面）
- **FR-017**: 验货记录列表必须支持按设备名称（编号）筛选
- **FR-018**: 验货记录列表必须支持按验货状态筛选（验机正常、验机异常）
- **FR-019**: 验货记录列表必须显示关键信息：设备编号、设备型号、客户名称、验货状态、验货时间

#### 验货记录编辑

- **FR-020**: 系统必须支持打开已有的验货记录进行编辑
- **FR-021**: 编辑验货记录时，必须允许修改检查项的勾选状态
- **FR-022**: 保存编辑后的验货记录时，系统必须重新计算验货状态（基于更新后的勾选情况）
- **FR-023**: 编辑验货记录时，必须记录修改时间（用于审计追溯）

### Key Entities

- **InspectionRecord（验货记录）**: 
  - 表示一次设备验货的完整记录
  - 关键属性：设备编号、关联的租赁记录ID、验货状态（正常/异常）、创建时间、修改时间、验货人员
  - 与检查项清单的关联关系（一对多）

- **InspectionCheckItem（验货检查项）**:
  - 表示验货清单中的单个检查项
  - 关键属性：检查项名称、是否勾选、所属验货记录ID
  - 检查项可能是基础检查项（固定的5项）或动态检查项（根据租赁内容生成）

- **Rental（租赁记录）**:
  - 需要扩展字段：代传照片（布尔值）
  - 验货记录通过租赁记录ID关联到具体的租赁订单
  - 租赁记录中的附件信息（手柄、镜头支架、个性化附件）用于生成验货检查清单

## Success Criteria

### Measurable Outcomes

- **SC-001**: 工作人员能够在 60 秒内完成一次设备验货（从输入设备编号到提交验货记录）
- **SC-002**: 验货清单的检查项准确率达到 100%（即检查清单完全匹配租赁记录中的附件内容，无遗漏、无错误）
- **SC-003**: 验货记录查询响应时间在 2 秒内（包括筛选操作）
- **SC-004**: 系统支持至少 5 个工作人员同时进行验货操作，不出现性能下降或数据冲突
- **SC-005**: 验货异常率能够准确统计（便于后续分析设备损坏率、客户问题等），误差率低于 1%
- **SC-006**: 验货记录的数据完整性达到 100%（所有必填字段都正确保存，无数据丢失）

## Assumptions

- 系统已有设备管理模块和租赁记录管理模块，可以通过设备编号查询租赁记录
- iPad 上的浏览器支持 HTML5 数字键盘（input type="number" 或 inputmode="numeric"）
- 工作人员已经过培训，熟悉验货检查项的含义和检查标准
- 验货通常在设备归还后立即进行，因此查询"今天之前"的租赁记录能覆盖绝大多数验货场景
- 如果一个设备在今天之前有多条租赁记录，验货针对的是最近（结束日期最晚）的那条
- 验货记录一旦创建，不会被删除（只能编辑），用于审计和历史追溯
- 个性化附件在租赁记录中有明确的名称字段，可以直接用于生成检查项名称
- 验货操作需要稳定的网络连接，如果网络中断，工作人员需要在网络恢复后重新提交

## Out of Scope

- 验货照片上传功能（未来可能需要拍照记录设备状态）
- 验货异常后的自动通知或工单生成（例如通知维修部门）
- 验货记录的统计分析和报表功能（例如设备损坏率分析、客户信用评分等）
- 验货记录的批量导出或打印功能
- 多语言支持（当前仅支持中文）
- 验货人员的权限管理（当前假设所有登录用户都可以验货）
